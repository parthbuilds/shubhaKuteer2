<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Coupons Management - Shubha Kuteer Admin</title>
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/style.css">
</head>
<body class="body">
    <div id="wrapper">
        <div id="page">
            <div class="layout-wrap">
                <!-- Sidebar -->
                <div class="section-menu-left">
                    <div class="box-logo">
                        <a href="/admin/index.html" id="site-logo-inner">
                            <span style="font-size: 24px; font-weight: bold; color: #333;">Shubha Kuteer</span>
                        </a>
                    </div>
                    <ul class="menu-list">
                        <li class="menu-item">
                            <a href="/admin/index.html" class="menu-item-button">
                                <div class="icon">üìä</div>
                                <div class="text">Dashboard</div>
                            </a>
                        </li>
                        <li class="menu-item has-children">
                            <a href="javascript:void(0);" class="menu-item-button">
                                <div class="icon">üé´</div>
                                <div class="text">Coupons</div>
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="/admin/banners.html" class="menu-item-button">
                                <div class="icon">üñºÔ∏è</div>
                                <div class="text">Banners</div>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Main Content -->
                <div class="section-content-right">
                    <div class="header-dashboard">
                        <h2>Coupons Management</h2>
                        <button onclick="showAddModal()" class="tf-button" style="float: right;">+ Add Coupon</button>
                    </div>

                    <div class="main-content">
                        <!-- Coupons Table -->
                        <div class="wg-box">
                            <div class="table-responsive">
                                <table class="table table-bordered" style="width: 100%;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5;">
                                            <th>Code</th>
                                            <th>Discount</th>
                                            <th>Type</th>
                                            <th>Min Order</th>
                                            <th>Usage</th>
                                            <th>Valid Until</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="couponsTableBody">
                                        <tr>
                                            <td colspan="8" style="text-align: center;">Loading coupons...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Coupon Modal -->
        <div id="couponModal" class="modal" style="display: none;">
            <div class="modal-dialog" style="max-width: 600px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 id="modalTitle">Add New Coupon</h4>
                        <button type="button" class="close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="couponForm" style="max-height: 500px; overflow-y: auto;">
                            <input type="hidden" id="couponId">

                            <div class="form-group">
                                <label>Code *</label>
                                <input type="text" id="couponCode" required
                                       style="text-transform: uppercase;"
                                       placeholder="e.g., SAVE10">
                            </div>

                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="couponDescription" rows="2"
                                          placeholder="Describe the coupon..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Discount Type *</label>
                                <select id="discountType" required onchange="handleDiscountTypeChange()">
                                    <option value="percentage">Percentage</option>
                                    <option value="fixed_amount">Fixed Amount</option>
                                    <option value="free_shipping">Free Shipping</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Discount Value *</label>
                                <input type="number" id="discountValue" required min="0" step="0.01">
                                <span id="discountValueLabel" style="margin-left: 10px;">%</span>
                            </div>

                            <div class="form-group">
                                <label>Minimum Order Value</label>
                                <input type="number" id="minOrderValue" min="0" step="0.01" placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label>Max Discount Amount</label>
                                <input type="number" id="maxDiscountAmount" min="0" step="0.01"
                                       placeholder="Leave empty for unlimited">
                            </div>

                            <div class="form-group">
                                <label>Usage Limit (Total)</label>
                                <input type="number" id="usageLimit" min="1" placeholder="Leave empty for unlimited">
                            </div>

                            <div class="form-group">
                                <label>User Limit (Per User)</label>
                                <input type="number" id="userLimit" min="1" value="1">
                            </div>

                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="datetime-local" id="startDate">
                            </div>

                            <div class="form-group">
                                <label>End Date</label>
                                <input type="datetime-local" id="endDate">
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="activeCoupon" checked>
                                    Active
                                </label>
                            </div>

                            <div class="form-group">
                                <label>Applicable Categories (Optional)</label>
                                <select id="applicableCategories" multiple size="5">
                                    <option value="">All Categories</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Applicable Products (Optional)</label>
                                <input type="text" id="applicableProducts"
                                       placeholder="Comma-separated product IDs">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="tf-button" onclick="closeModal()">Cancel</button>
                        <button type="button" class="tf-button btn-primary" onclick="saveCoupon()">Save Coupon</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allCoupons = [];
        let allCategories = [];

        // Load coupons on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCoupons();
            await loadCategories();
        });

        // Load all coupons
        async function loadCoupons() {
            try {
                console.log('Loading coupons...'); // Blue text for visibility
                const res = await fetch('/api/admin/coupons');
                if (!res.ok) throw new Error('Failed to load coupons');

                const data = await res.json();
                allCoupons = data.coupons || [];

                renderCouponsTable();
            } catch (error) {
                console.error('Error loading coupons:', error);
                alert('Failed to load coupons');
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const res = await fetch('/api/admin/categories/public');
                if (!res.ok) throw new Error('Failed to load categories');

                const categories = await res.json();
                const select = document.getElementById('applicableCategories');

                select.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });

                allCategories = categories;
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Render coupons table
        function renderCouponsTable() {
            const tbody = document.getElementById('couponsTableBody');

            if (allCoupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No coupons found</td></tr>';
                return;
            }

            tbody.innerHTML = allCoupons.map(coupon => {
                const discountDisplay = coupon.discount_type === 'percentage'
                    ? `${coupon.discount_value}%`
                    : coupon.discount_type === 'free_shipping'
                    ? 'Free Shipping'
                    : `‚Çπ${coupon.discount_value}`;

                const statusClass = coupon.active ? 'success' : 'warning';
                const statusText = coupon.active ? 'Active' : 'Inactive';

                return `
                    <tr>
                        <td><strong style="color: #0066cc;">${coupon.code}</strong></td>
                        <td>${discountDisplay}</td>
                        <td>${coupon.discount_type.replace(/_/g, ' ').toUpperCase()}</td>
                        <td>‚Çπ${coupon.min_order_value || '0'}</td>
                        <td>${coupon.usage_count || 0}${coupon.usage_limit ? '/' + coupon.usage_limit : ''}</td>
                        <td>${formatDate(coupon.end_date)}</td>
                        <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editCoupon(${coupon.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCoupon(${coupon.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show add modal
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Coupon';
            document.getElementById('couponForm').reset();
            document.getElementById('couponId').value = '';
            document.getElementById('activeCoupon').checked = true;
            document.getElementById('couponModal').style.display = 'block';
        }

        // Edit coupon
        async function editCoupon(id) {
            const coupon = allCoupons.find(c => c.id === id);
            if (!coupon) return;

            document.getElementById('modalTitle').textContent = 'Edit Coupon';
            document.getElementById('couponId').value = coupon.id;

            // Fill form
            document.getElementById('couponCode').value = coupon.code;
            document.getElementById('couponDescription').value = coupon.description || '';
            document.getElementById('discountType').value = coupon.discount_type;
            document.getElementById('discountValue').value = coupon.discount_value;
            document.getElementById('minOrderValue').value = coupon.min_order_value || '';
            document.getElementById('maxDiscountAmount').value = coupon.max_discount_amount || '';
            document.getElementById('usageLimit').value = coupon.usage_limit || '';
            document.getElementById('userLimit').value = coupon.user_limit || 1;
            document.getElementById('startDate').value = formatDateTimeLocal(coupon.start_date);
            document.getElementById('endDate').value = formatDateTimeLocal(coupon.end_date);
            document.getElementById('activeCoupon').checked = coupon.active;

            handleDiscountTypeChange();
            document.getElementById('couponModal').style.display = 'block';
        }

        // Save coupon
        async function saveCoupon() {
            const id = document.getElementById('couponId').value;
            const isEdit = !!id;

            const data = {
                code: document.getElementById('couponCode').value,
                description: document.getElementById('couponDescription').value,
                discount_type: document.getElementById('discountType').value,
                discount_value: parseFloat(document.getElementById('discountValue').value) || 0,
                min_order_value: parseFloat(document.getElementById('minOrderValue').value) || null,
                max_discount_amount: document.getElementById('maxDiscountAmount').value
                    ? parseFloat(document.getElementById('maxDiscountAmount').value)
                    : null,
                usage_limit: document.getElementById('usageLimit').value
                    ? parseInt(document.getElementById('usageLimit').value)
                    : null,
                user_limit: parseInt(document.getElementById('userLimit').value) || 1,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                active: document.getElementById('activeCoupon').checked
            };

            if (!data.code || !data.discount_type) {
                alert('Code and Discount Type are required');
                return;
            }

            try {
                const url = isEdit ? `/api/admin/coupons/${id}` : '/api/admin/coupons';
                const method = isEdit ? 'PUT' : 'POST';

                console.log('Saving coupon:', data);

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert(isEdit ? 'Coupon updated successfully' : 'Coupon created successfully');
                    closeModal();
                    await loadCoupons();
                } else {
                    alert(result.message || 'Failed to save coupon');
                }
            } catch (error) {
                console.error('Error saving coupon:', error);
                alert('Failed to save coupon');
            }
        }

        // Delete coupon
        async function deleteCoupon(id) {
            if (!confirm('Are you sure you want to delete this coupon?')) return;

            try {
                console.log('Deleting coupon:', id);
                const res = await fetch(`/api/admin/coupons/${id}`, {
                    method: 'DELETE'
                });

                const result = await res.json();

                if (result.success) {
                    alert('Coupon deleted successfully');
                    await loadCoupons();
                } else {
                    alert(result.message || 'Failed to delete coupon');
                }
            } catch (error) {
                console.error('Error deleting coupon:', error);
                alert('Failed to delete coupon');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('couponModal').style.display = 'none';
        }

        // Handle discount type change
        function handleDiscountTypeChange() {
            const type = document.getElementById('discountType').value;
            const label = document.getElementById('discountValueLabel');

            if (type === 'percentage') {
                label.textContent = '%';
                label.style.display = 'inline';
            } else if (type === 'fixed_amount') {
                label.textContent = '‚Çπ';
                label.style.display = 'inline';
            } else {
                label.style.display = 'none';
            }
        }

        // Format date for datetime-local input
        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().slice(0, 16);
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        }
    </script>
</body>
</html>
