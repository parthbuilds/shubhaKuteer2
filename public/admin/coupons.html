<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Coupons Management - Shubha Kuteer Admin</title>
    <link rel="stylesheet" type="text/css" href="/admin/css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/animation.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/style.css">
    <link rel="stylesheet" href="/admin/font/fonts.css">
    <link rel="stylesheet" href="/admin/icon/style.css">
    <link rel="shortcut icon" href="/admin/images/favicon.png">
    <script>
        (async () => {
            try {
                const res = await fetch("/api/admin/auth/check", { credentials: "include" });
                if (!res.ok) window.location.href = "/admin/login.html";
            } catch {
                window.location.href = "/admin/login.html";
            }
        })();
    </script>
    <style>
        #couponFormSection { display: none; }
        #couponFormSection .cols { display: flex; gap: 20px; }
        #couponFormSection .cols > fieldset { flex: 1; }
        #couponFormSection textarea { height: 80px !important; }
        .category-dropdown { position: relative; }
        .category-dropdown-toggle {
            width: 100%; padding: 10px 14px; border: 1px solid var(--Input);
            border-radius: 8px; font-size: 14px; background: #fff;
            cursor: pointer; display: flex; align-items: center;
            justify-content: space-between; min-height: 44px;
        }
        .category-dropdown-toggle:hover { border-color: #2275fc; }
        .category-dropdown-toggle .placeholder { color: #999; }
        .category-dropdown-menu {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1px solid var(--Input); border-radius: 8px;
            margin-top: 4px; max-height: 200px; overflow-y: auto;
            z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .category-dropdown-menu.open { display: block; }
        .category-dropdown-menu label {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 14px; cursor: pointer; font-size: 14px;
            transition: background 0.15s;
        }
        .category-dropdown-menu label:hover { background: #f5f5f5; }
        .category-dropdown-menu input[type="checkbox"] {
            width: 16px; height: 16px; accent-color: #2275fc; cursor: pointer;
        }
        .selected-cats { display: flex; flex-wrap: wrap; gap: 4px; }
        .selected-cat-tag {
            background: #e8f0fe; color: #2275fc; padding: 2px 8px;
            border-radius: 4px; font-size: 12px;
        }
    </style>
</head>

<body class="body">

    <div id="wrapper">
        <div id="page" class="">
            <div class="layout-wrap">
                <!-- preload -->
                <div id="preload" class="preload-container">
                    <div class="preloading"><span></span></div>
                </div>

                <!-- section-menu-left -->
                <div class="section-menu-left">
                    <div class="box-logo w-120">
                        <a href="/admin/index.html" id="site-logo-inner">
                            <img class="" id="logo_header" alt="" src="/admin/images/logo/logo.png"
                                data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png">
                        </a>
                        <div class="button-show-hide">
                            <i class="icon-menu-left"></i>
                        </div>
                    </div>
                    <div class="section-menu-left-wrap">
                        <div class="center">
                            <div class="center-item">
                                <div class="center-heading">Main Home</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-grid"></i></div>
                                            <div class="text">Dashboard</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/index.html" class="">
                                                    <div class="text">Dashboard</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">All page</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-shopping-cart"></i></div>
                                            <div class="text">Ecommerce</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-product.html" class="">
                                                    <div class="text">Add Product</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/product-list.html" class="">
                                                    <div class="text">Product List</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-layers"></i></div>
                                            <div class="text">Category</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/category-list.html" class="">
                                                    <div class="text">Category list</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/new-category.html" class="">
                                                    <div class="text">New category</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-box"></i></div>
                                            <div class="text">Attributes</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/attributes.html" class="">
                                                    <div class="text">Attributes</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-attributes.html" class="">
                                                    <div class="text">Add attributes</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-file-plus"></i></div>
                                            <div class="text">Order</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/order-list.html" class="">
                                                    <div class="text">Order list</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-tag"></i></div>
                                            <div class="text">Marketing</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/banners.html" class="">
                                                    <div class="text">Banners</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/coupons.html" class="active">
                                                    <div class="text">Coupons</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-user"></i></div>
                                            <div class="text">User</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/all-user.html" class="">
                                                    <div class="text">All user</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-new-user.html" class="">
                                                    <div class="text">Add new user</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li></ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">Setting</div>
                                <ul class="menu-list">
                                    <li class="menu-item">
                                        <a href="/admin/setting.html" class="">
                                            <div class="icon"><i class="icon-settings"></i></div>
                                            <div class="text">Setting</div>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">Connect us</div>
                                <ul class="wg-social">
                                    <li><a href="#"><i class="icon-facebook"></i></a></li>
                                    <li class="active"><a href="#"><i class="icon-twitter"></i></a></li>
                                    <li><a href="#"><i class="icon-linkedin"></i></a></li>
                                    <li><a href="#"><i class="icon-instagram"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="bot text-center">
                            <div class="wrap">
                                <div class="mb-20">
                                    <img src="/admin/images/menu-left/img-bot.png" alt="">
                                </div>
                                <div class="mb-20">
                                    <h6>Hi, how can we help?</h6>
                                    <div class="text">Contact us if you have any assistance, we will contact you as soon as possible</div>
                                </div>
                                <a href="mailto:parthbuilds@gmail.com" class="tf-button w-full">Contact</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- section-content-right -->
                <div class="section-content-right">
                    <!-- header-dashboard -->
                    <div class="header-dashboard">
                        <div class="wrap">
                            <div class="header-left">
                                <a href="/admin/index.html">
                                    <img class="" id="logo_header_mobile" alt="" src="/admin/images/logo/logo.png"
                                        data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png"
                                        data-width="154px" data-height="52px" data-retina="images/logo/logo@2x.png">
                                </a>
                                <div class="button-show-hide">
                                    <i class="icon-menu-left"></i>
                                </div>
                                <form class="form-search flex-grow">
                                    <fieldset class="name">
                                        <input type="text" placeholder="Search here..." class="show-search" name="name"
                                            tabindex="2" value="" aria-required="true" required="">
                                    </fieldset>
                                    <div class="button-submit">
                                        <button class="" type="submit"><i class="icon-search"></i></button>
                                    </div>
                                </form>
                            </div>
                            <div class="header-grid">
                                <div class="header-item country">
                                    <select class="image-select no-text">
                                        <option data-thumbnail="images/country/3.png">ENG</option>
                                        <option data-thumbnail="images/country/9.png">VIE</option>
                                    </select>
                                </div>
                                <div class="header-item button-dark-light">
                                    <i class="icon-moon"></i>
                                </div>
                                <div class="popup-wrap user type-header">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button"
                                            id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="header-user wg-user">
                                                <span class="image">
                                                    <img src="/admin/images/avatar/user-1.png" alt="">
                                                </span>
                                                <span class="flex flex-column">
                                                    <span id="admin-name" class="body-title mb-2">Loading...</span>
                                                    <span id="admin-role" class="text-tiny">Admin</span>
                                                </span>
                                            </span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end has-content"
                                            aria-labelledby="dropdownMenuButton3">
                                            <li>
                                                <a href="#" class="user-item">
                                                    <div class="icon"><i class="icon-user"></i></div>
                                                    <div class="body-title-2">Account</div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="/admin/setting.html" class="user-item">
                                                    <div class="icon"><i class="icon-settings"></i></div>
                                                    <div class="body-title-2">Setting</div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="/admin/login.html" class="user-item">
                                                    <div class="icon"><i class="icon-log-out"></i></div>
                                                    <div class="body-title-2">Log out</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- main-content -->
                    <div class="main-content">
                        <div class="main-content-inner">
                            <div class="main-content-wrap">
                                <div class="flex items-center flex-wrap justify-between gap20 mb-27">
                                    <h3>Coupons Management</h3>
                                    <ul class="breadcrumbs flex items-center flex-wrap justify-start gap10">
                                        <li><a href="/admin/index.html"><div class="text-tiny">Dashboard</div></a></li>
                                        <li><i class="icon-chevron-right"></i></li>
                                        <li><a href="#"><div class="text-tiny">Marketing</div></a></li>
                                        <li><i class="icon-chevron-right"></i></li>
                                        <li><div class="text-tiny">Coupons</div></li>
                                    </ul>
                                </div>

                                <!-- coupon-form-section -->
                                <div id="couponFormSection" class="wg-box mb-20">
                                    <div class="flex items-center justify-between gap10 mb-20">
                                        <h5 id="modalTitle">Add New Coupon</h5>
                                    </div>
                                    <form id="couponForm" class="form-add-product">
                                        <input type="hidden" id="couponId">

                                        <div class="cols">
                                            <fieldset>
                                                <div class="body-title mb-10">Code <span class="tf-color-1">*</span></div>
                                                <input type="text" id="couponCode" required style="text-transform: uppercase;" placeholder="e.g., SAVE10">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Discount Type <span class="tf-color-1">*</span></div>
                                                <div class="select">
                                                    <select id="discountType" required onchange="handleDiscountTypeChange()">
                                                        <option value="percentage">Percentage</option>
                                                        <option value="fixed_amount">Fixed Amount</option>
                                                        <option value="free_shipping">Free Shipping</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <fieldset class="mt-20">
                                            <div class="body-title mb-10">Description</div>
                                            <textarea id="couponDescription" placeholder="Describe the coupon..."></textarea>
                                        </fieldset>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Discount Value <span class="tf-color-1">*</span></div>
                                                <input type="number" id="discountValue" required min="0" step="0.01">
                                                <span id="discountValueLabel" style="margin-left: 10px; font-weight: 600;">%</span>
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Minimum Order Value</div>
                                                <input type="number" id="minOrderValue" min="0" step="0.01" placeholder="0.00">
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Max Discount Amount</div>
                                                <input type="number" id="maxDiscountAmount" min="0" step="0.01" placeholder="Leave empty for unlimited">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Usage Limit (Total)</div>
                                                <input type="number" id="usageLimit" min="1" placeholder="Leave empty for unlimited">
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">User Limit (Per User)</div>
                                                <input type="number" id="userLimit" min="1" value="1">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">&nbsp;</div>
                                                <label><input type="checkbox" id="activeCoupon" checked> Active</label>
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Start Date</div>
                                                <input type="datetime-local" id="startDate">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">End Date</div>
                                                <input type="datetime-local" id="endDate">
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Applicable Categories</div>
                                                <div class="category-dropdown" id="categoryDropdown">
                                                    <div class="category-dropdown-toggle" id="categoryDropdownToggle">
                                                        <span class="selected-cats" id="selectedCatsDisplay"><span class="placeholder">All Categories</span></span>
                                                        <i class="icon-chevron-down" style="font-size:12px; color:#999;"></i>
                                                    </div>
                                                    <div class="category-dropdown-menu" id="categoryDropdownMenu">
                                                        <!-- populated by JS -->
                                                    </div>
                                                </div>
                                                <input type="hidden" id="applicableCategories">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Applicable Products</div>
                                                <input type="text" id="applicableProducts" placeholder="Comma-separated product IDs">
                                            </fieldset>
                                        </div>

                                        <div class="cols gap10 mt-20">
                                            <button type="button" class="tf-button w-full" onclick="closeFormSection()">Cancel</button>
                                            <button type="button" class="tf-button style-1 w-full" onclick="saveCoupon()">Save Coupon</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- coupon-list -->
                                <div class="wg-box mb-20">
                                    <div class="wg-filter flex items-center justify-between gap10 flex-wrap">
                                        <div class="flex-grow">
                                            <div class="text-tiny mb-2">Manage discount coupons for your customers</div>
                                        </div>
                                        <button onclick="showAddModal()" class="tf-button style-1 w208"><i
                                                class="icon-plus"></i>Add Coupon</button>
                                    </div>

                                    <div class="divider"></div>

                                    <div class="wg-table table-coupon-list">
                                        <ul class="table-title flex gap20 mb-14">
                                            <li><div class="body-title">Code</div></li>
                                            <li><div class="body-title">Discount</div></li>
                                            <li><div class="body-title">Type</div></li>
                                            <li><div class="body-title">Min Order</div></li>
                                            <li><div class="body-title">Usage</div></li>
                                            <li><div class="body-title">Valid Until</div></li>
                                            <li><div class="body-title">Status</div></li>
                                            <li><div class="body-title">Action</div></li>
                                        </ul>
                                        <ul id="couponsList" class="flex flex-column">
                                            <li class="product-item gap14"><div class="body-text">Loading coupons...</div></li>
                                        </ul>
                                    </div>
                                    <div class="divider"></div>
                                    <div class="flex items-center justify-between flex-wrap gap10">
                                        <div id="coupon-entries-info" class="text-tiny"></div>
                                        <ul id="coupon-pagination" class="wg-pagination"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- bottom-page -->
                        <div class="bottom-page">
                            <div class="body-text">Copyright © 2024 Shubha Kuteer Design with</div>
                            <i class="icon-heart"></i>
                            <div class="body-text">by <a href="https://aptmedia.in">APT Media</a> All rights reserved.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        let allCoupons = [];
        let allCategories = [];
        let couponCurrentPage = 1;
        const couponPageSize = 10;

        // Load admin data
        async function loadAdminData() {
            try {
                const res = await fetch("/api/admin/users/me");
                if (!res.ok) throw new Error("Failed to fetch admin");
                const data = await res.json();
                document.getElementById("admin-name").textContent = data.admin.name;
                document.getElementById("admin-role").textContent = data.admin.role;
            } catch (err) {
                console.error("Error loading admin:", err);
            }
        }

        // Load coupons on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAdminData();
            await loadCoupons();
            await loadCategories();
        });

        // Load all coupons
        async function loadCoupons() {
            try {
                console.log('Loading coupons...');
                const res = await fetch('/api/admin/coupons');
                if (!res.ok) throw new Error('Failed to load coupons');

                const data = await res.json();
                allCoupons = data.coupons || [];

                renderCouponsTable();
            } catch (error) {
                console.error('Error loading coupons:', error);
                document.getElementById('couponsList').innerHTML = '<li class="product-item gap14"><div class="body-text">Failed to load coupons</div></li>';
            }
        }

        // Load categories
        let selectedCategoryIds = [];

        async function loadCategories() {
            try {
                const res = await fetch('/api/admin/categories/public');
                if (!res.ok) throw new Error('Failed to load categories');

                const categories = await res.json();
                allCategories = categories;

                const menu = document.getElementById('categoryDropdownMenu');
                menu.innerHTML = '';
                categories.forEach(cat => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" value="${cat.id}" data-name="${cat.name}"> ${cat.name}`;
                    label.querySelector('input').addEventListener('change', onCategoryCheckChange);
                    menu.appendChild(label);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function onCategoryCheckChange() {
            const checkboxes = document.querySelectorAll('#categoryDropdownMenu input[type=checkbox]');
            selectedCategoryIds = [];
            checkboxes.forEach(cb => { if (cb.checked) selectedCategoryIds.push(cb.value); });
            updateCategoryDisplay();
        }

        function updateCategoryDisplay() {
            const display = document.getElementById('selectedCatsDisplay');
            const hidden = document.getElementById('applicableCategories');
            if (selectedCategoryIds.length === 0) {
                display.innerHTML = '<span class="placeholder">All Categories</span>';
                hidden.value = '';
            } else {
                const names = [];
                document.querySelectorAll('#categoryDropdownMenu input[type=checkbox]:checked').forEach(cb => {
                    names.push(cb.dataset.name);
                });
                display.innerHTML = names.map(n => `<span class="selected-cat-tag">${n}</span>`).join('');
                hidden.value = selectedCategoryIds.join(',');
            }
        }

        // Toggle dropdown
        document.getElementById('categoryDropdownToggle').addEventListener('click', () => {
            document.getElementById('categoryDropdownMenu').classList.toggle('open');
        });
        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!document.getElementById('categoryDropdown').contains(e.target)) {
                document.getElementById('categoryDropdownMenu').classList.remove('open');
            }
        });

        // Render coupons table with pagination
        function renderCouponsTable() {
            const list = document.getElementById('couponsList');
            const entriesInfo = document.getElementById('coupon-entries-info');
            const pagination = document.getElementById('coupon-pagination');

            if (allCoupons.length === 0) {
                list.innerHTML = '<li class="product-item gap14"><div class="body-text">No coupons found</div></li>';
                entriesInfo.textContent = '';
                pagination.innerHTML = '';
                return;
            }

            const total = allCoupons.length;
            const totalPages = Math.ceil(total / couponPageSize);
            if (couponCurrentPage > totalPages) couponCurrentPage = totalPages;
            const start = (couponCurrentPage - 1) * couponPageSize;
            const end = Math.min(couponCurrentPage * couponPageSize, total);
            const pageCoupons = allCoupons.slice(start, end);

            list.innerHTML = pageCoupons.map(coupon => {
                const discountDisplay = coupon.discount_type === 'percentage'
                    ? `${coupon.discount_value}%`
                    : coupon.discount_type === 'free_shipping'
                    ? 'Free Shipping'
                    : `\u20b9${coupon.discount_value}`;

                const statusClass = coupon.active ? 'success' : 'warning';
                const statusText = coupon.active ? 'Active' : 'Inactive';

                return `
                    <li class="product-item gap14" style="align-items: center;">
                        <div style="flex: 1;"><strong style="color: #0066cc;">${coupon.code}</strong></div>
                        <div style="flex: 1;">${discountDisplay}</div>
                        <div style="flex: 1;">${coupon.discount_type.replace(/_/g, ' ').toUpperCase()}</div>
                        <div style="flex: 1;">\u20b9${coupon.min_order_value || '0'}</div>
                        <div style="flex: 1;">${coupon.usage_count || 0}${coupon.usage_limit ? '/' + coupon.usage_limit : ''}</div>
                        <div style="flex: 1;">${formatDate(coupon.end_date)}</div>
                        <div style="flex: 1;"><span class="block-available ${statusClass === 'success' ? '' : 'warning'}">${statusText}</span></div>
                        <div class="list-icon-function">
                            <div class="item edit" onclick="editCoupon(${coupon.id})"><i class="icon-edit-3"></i></div>
                            <div class="item trash" onclick="deleteCoupon(${coupon.id})"><i class="icon-trash-2"></i></div>
                        </div>
                    </li>
                `;
            }).join('');

            // Entries info
            entriesInfo.textContent = `Showing ${start + 1}\u2013${end} of ${total} entries`;

            // Pagination
            pagination.innerHTML = '';
            if (totalPages <= 1) return;
            const prevLi = document.createElement('li');
            prevLi.innerHTML = '<a href="#"><i class="icon-chevron-left"></i></a>';
            if (couponCurrentPage === 1) prevLi.classList.add('disabled');
            prevLi.addEventListener('click', e => { e.preventDefault(); if (couponCurrentPage > 1) { couponCurrentPage--; renderCouponsTable(); } });
            pagination.appendChild(prevLi);
            for (let i = 1; i <= totalPages; i++) {
                const pLi = document.createElement('li');
                pLi.innerHTML = `<a href="#">${i}</a>`;
                if (i === couponCurrentPage) pLi.classList.add('active');
                pLi.addEventListener('click', e => { e.preventDefault(); couponCurrentPage = i; renderCouponsTable(); });
                pagination.appendChild(pLi);
            }
            const nextLi = document.createElement('li');
            nextLi.innerHTML = '<a href="#"><i class="icon-chevron-right"></i></a>';
            if (couponCurrentPage === totalPages) nextLi.classList.add('disabled');
            nextLi.addEventListener('click', e => { e.preventDefault(); if (couponCurrentPage < totalPages) { couponCurrentPage++; renderCouponsTable(); } });
            pagination.appendChild(nextLi);
        }

        // Show add modal
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Coupon';
            document.getElementById('couponForm').reset();
            document.getElementById('couponId').value = '';
            document.getElementById('activeCoupon').checked = true;
            resetCategoryCheckboxes();
            document.getElementById('couponFormSection').style.display = 'block';
            document.getElementById('couponFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        function resetCategoryCheckboxes() {
            selectedCategoryIds = [];
            document.querySelectorAll('#categoryDropdownMenu input[type=checkbox]').forEach(cb => cb.checked = false);
            updateCategoryDisplay();
        }

        // Edit coupon
        async function editCoupon(id) {
            const coupon = allCoupons.find(c => c.id === id);
            if (!coupon) return;

            document.getElementById('modalTitle').textContent = 'Edit Coupon';
            document.getElementById('couponId').value = coupon.id;

            // Fill form
            document.getElementById('couponCode').value = coupon.code;
            document.getElementById('couponDescription').value = coupon.description || '';
            document.getElementById('discountType').value = coupon.discount_type;
            document.getElementById('discountValue').value = coupon.discount_value;
            document.getElementById('minOrderValue').value = coupon.min_order_value || '';
            document.getElementById('maxDiscountAmount').value = coupon.max_discount_amount || '';
            document.getElementById('usageLimit').value = coupon.usage_limit || '';
            document.getElementById('userLimit').value = coupon.user_limit || 1;
            document.getElementById('startDate').value = formatDateTimeLocal(coupon.start_date);
            document.getElementById('endDate').value = formatDateTimeLocal(coupon.end_date);
            document.getElementById('activeCoupon').checked = coupon.active;

            handleDiscountTypeChange();
            document.getElementById('couponFormSection').style.display = 'block';
            document.getElementById('couponFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Save coupon
        async function saveCoupon() {
            const id = document.getElementById('couponId').value;
            const isEdit = !!id;

            const data = {
                code: document.getElementById('couponCode').value.toUpperCase(),
                description: document.getElementById('couponDescription').value,
                discount_type: document.getElementById('discountType').value,
                discount_value: parseFloat(document.getElementById('discountValue').value) || 0,
                min_order_value: parseFloat(document.getElementById('minOrderValue').value) || null,
                max_discount_amount: document.getElementById('maxDiscountAmount').value
                    ? parseFloat(document.getElementById('maxDiscountAmount').value)
                    : null,
                usage_limit: document.getElementById('usageLimit').value
                    ? parseInt(document.getElementById('usageLimit').value)
                    : null,
                user_limit: parseInt(document.getElementById('userLimit').value) || 1,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                active: document.getElementById('activeCoupon').checked
            };

            if (!data.code || !data.discount_type) {
                alert('Code and Discount Type are required');
                return;
            }

            try {
                const url = isEdit ? `/api/admin/coupons/${id}` : '/api/admin/coupons';
                const method = isEdit ? 'PUT' : 'POST';

                console.log('Saving coupon:', data);

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert(isEdit ? 'Coupon updated successfully' : 'Coupon created successfully');
                    closeFormSection();
                    await loadCoupons();
                } else {
                    alert(result.message || 'Failed to save coupon');
                }
            } catch (error) {
                console.error('Error saving coupon:', error);
                alert('Failed to save coupon');
            }
        }

        // Delete coupon
        async function deleteCoupon(id) {
            if (!confirm('Are you sure you want to delete this coupon?')) return;

            try {
                console.log('Deleting coupon:', id);
                const res = await fetch(`/api/admin/coupons/${id}`, {
                    method: 'DELETE'
                });

                const result = await res.json();

                if (result.success) {
                    alert('Coupon deleted successfully');
                    await loadCoupons();
                } else {
                    alert(result.message || 'Failed to delete coupon');
                }
            } catch (error) {
                console.error('Error deleting coupon:', error);
                alert('Failed to delete coupon');
            }
        }

        // Close form section
        function closeFormSection() {
            document.getElementById('couponFormSection').style.display = 'none';
        }
        function closeModal() {
            closeFormSection();
        }

        // Handle discount type change
        function handleDiscountTypeChange() {
            const type = document.getElementById('discountType').value;
            const label = document.getElementById('discountValueLabel');

            if (type === 'percentage') {
                label.textContent = '%';
                label.style.display = 'inline';
            } else if (type === 'fixed_amount') {
                label.textContent = '₹';
                label.style.display = 'inline';
            } else {
                label.style.display = 'none';
            }
        }

        // Format date for datetime-local input
        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().slice(0, 16);
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        }
    </script>

    <script src="/admin/js/jquery.min.js"></script>
    <script src="/admin/js/bootstrap.min.js"></script>
    <script src="/admin/js/bootstrap-select.min.js"></script>
    <script src="/admin/js/main.js"></script>
</body>
</html>
