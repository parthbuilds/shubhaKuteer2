<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Banners Management - Shubha Kuteer Admin</title>
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/style.css">
</head>
<body class="body">
    <div id="wrapper">
        <div id="page">
            <div class="layout-wrap">
                <!-- Sidebar -->
                <div class="section-menu-left">
                    <div class="box-logo">
                        <a href="/admin/index.html" id="site-logo-inner">
                            <span style="font-size: 24px; font-weight: bold; color: #333;">Shubha Kuteer</span>
                        </a>
                    </div>
                    <ul class="menu-list">
                        <li class="menu-item">
                            <a href="/admin/index.html" class="menu-item-button">
                                <div class="icon">üìä</div>
                                <div class="text">Dashboard</div>
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="/admin/coupons.html" class="menu-item-button">
                                <div class="icon">üé´</div>
                                <div class="text">Coupons</div>
                            </a>
                        </li>
                        <li class="menu-item has-children">
                            <a href="javascript:void(0);" class="menu-item-button">
                                <div class="icon">üñºÔ∏è</div>
                                <div class="text">Banners</div>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Main Content -->
                <div class="section-content-right">
                    <div class="header-dashboard">
                        <h2>Banners Management</h2>
                        <button onclick="showAddModal()" class="tf-button" style="float: right;">+ Add Banner</button>
                    </div>

                    <div class="main-content">
                        <!-- Banner Preview & List -->
                        <div style="display: flex; gap: 20px;">
                            <!-- Banner List -->
                            <div class="wg-box" style="flex: 1;">
                                <table class="table table-bordered" style="width: 100%;">
                                    <thead>
                                        <tr style="background-color: #f5f5f5;">
                                            <th>Image</th>
                                            <th>Title</th>
                                            <th>Type</th>
                                            <th>Page</th>
                                            <th>Position</th>
                                            <th>Dates</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bannersTableBody">
                                        <tr>
                                            <td colspan="7" style="text-align: center;">Loading banners...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Banner Modal -->
        <div id="bannerModal" class="modal" style="display: none;">
            <div class="modal-dialog" style="max-width: 700px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 id="modalTitle">Add New Banner</h4>
                        <button type="button" class="close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="bannerForm">
                            <input type="hidden" id="bannerId">

                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" id="bannerTitle" required placeholder="e.g., Summer Sale">
                            </div>

                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="bannerDescription" rows="2"
                                          placeholder="Banner description..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Banner Type *</label>
                                <select id="bannerType" required>
                                    <option value="hero">Hero</option>
                                    <option value="category">Category</option>
                                    <option value="promotional">Promotional</option>
                                    <option value="sidebar">Sidebar</option>
                                    <option value="footer">Footer</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Image URL *</label>
                                <input type="text" id="imageUrl" required
                                       placeholder="https://example.com/banner.jpg">
                                <div id="imagePreview" style="margin-top: 10px; max-height: 100px; overflow: hidden;"></div>
                            </div>

                            <div class="form-group">
                                <label>Mobile Image URL (Optional)</label>
                                <input type="text" id="mobileImageUrl"
                                       placeholder="https://example.com/banner-mobile.jpg">
                            </div>

                            <div class="form-group">
                                <label>Link URL (Optional)</label>
                                <input type="text" id="linkUrl"
                                       placeholder="https://example.com/products">
                            </div>

                            <div class="form-group">
                                <label>Link Target</label>
                                <select id="linkTarget">
                                    <option value="_self">Same Window (_self)</option>
                                    <option value="_blank">New Window (_blank)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Position (Order)</label>
                                <input type="number" id="position" min="0" value="0"
                                       placeholder="Lower numbers appear first">
                            </div>

                            <div class="form-group">
                                <label>Page Location (Optional)</label>
                                <select id="pageLocation">
                                    <option value="">All Pages</option>
                                    <option value="home">Home</option>
                                    <option value="shop">Shop</option>
                                    <option value="category:bed-linen">Bed Linen</option>
                                    <option value="category:dog-food">Dog Food</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Start Date (Optional)</label>
                                <input type="datetime-local" id="startDate">
                            </div>

                            <div class="form-group">
                                <label>End Date (Optional)</label>
                                <input type="datetime-local" id="endDate">
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="activeBanner" checked>
                                    Active
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="tf-button" onclick="closeModal()">Cancel</button>
                        <button type="button" class="tf-button btn-primary" onclick="saveBanner()">Save Banner</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allBanners = [];

        // Load banners on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadBanners();
        });

        // Load all banners
        async function loadBanners() {
            try {
                console.log('Loading banners...');
                const res = await fetch('/api/admin/banners');
                if (!res.ok) throw new Error('Failed to load banners');

                const data = await res.json();
                allBanners = data.banners || [];

                renderBannersTable();
            } catch (error) {
                console.error('Error loading banners:', error);
                alert('Failed to load banners');
            }
        }

        // Render banners table
        function renderBannersTable() {
            const tbody = document.getElementById('bannersTableBody');

            if (allBanners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No banners found</td></tr>';
                return;
            }

            tbody.innerHTML = allBanners.map(banner => {
                const statusClass = banner.active ? 'success' : 'warning';
                const statusText = banner.active ? 'Active' : 'Inactive';

                return `
                    <tr>
                        <td>
                            <img src="${banner.image_url}" alt="${banner.title}"
                                 style="max-width: 100px; max-height: 50px; object-fit: cover;">
                        </td>
                        <td><strong>${banner.title || 'N/A'}</strong></td>
                        <td>${banner.banner_type}</td>
                        <td>${banner.page_location || 'All'}</td>
                        <td>${banner.position}</td>
                        <td>
                            ${banner.start_date ? formatDate(banner.start_date) : 'N/A'}
                            ${banner.end_date ? ' to ' + formatDate(banner.end_date) : ''}
                        </td>
                        <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editBanner(${banner.id})">Edit</button>
                            <button class="btn btn-sm btn-info" onclick="previewBanner(${banner.id})">üëÅÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBanner(${banner.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show add modal
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Banner';
            document.getElementById('bannerForm').reset();
            document.getElementById('bannerId').value = '';
            document.getElementById('activeBanner').checked = true;
            document.getElementById('bannerModal').style.display = 'block';
        }

        // Edit banner
        async function editBanner(id) {
            const banner = allBanners.find(b => b.id === id);
            if (!banner) return;

            document.getElementById('modalTitle').textContent = 'Edit Banner';
            document.getElementById('bannerId').value = banner.id;

            // Fill form
            document.getElementById('bannerTitle').value = banner.title || '';
            document.getElementById('bannerDescription').value = banner.description || '';
            document.getElementById('bannerType').value = banner.banner_type;
            document.getElementById('imageUrl').value = banner.image_url;
            document.getElementById('mobileImageUrl').value = banner.mobile_image_url || '';
            document.getElementById('linkUrl').value = banner.link_url || '';
            document.getElementById('linkTarget').value = banner.link_target || '_self';
            document.getElementById('position').value = banner.position;
            document.getElementById('pageLocation').value = banner.page_location || '';
            document.getElementById('startDate').value = formatDateTimeLocal(banner.start_date);
            document.getElementById('endDate').value = formatDateTimeLocal(banner.end_date);
            document.getElementById('activeBanner').checked = banner.active;

            document.getElementById('bannerModal').style.display = 'block';
        }

        // Preview banner
        function previewBanner(id) {
            const banner = allBanners.find(b => b.id === id);
            if (banner && banner.image_url) {
                window.open(banner.image_url, '_blank');
            }
        }

        // Save banner
        async function saveBanner() {
            const id = document.getElementById('bannerId').value;
            const isEdit = !!id;

            const data = {
                title: document.getElementById('bannerTitle').value,
                description: document.getElementById('bannerDescription').value,
                banner_type: document.getElementById('bannerType').value,
                image_url: document.getElementById('imageUrl').value,
                mobile_image_url: document.getElementById('mobileImageUrl').value || null,
                link_url: document.getElementById('linkUrl').value || null,
                link_target: document.getElementById('linkTarget').value,
                position: parseInt(document.getElementById('position').value) || 0,
                page_location: document.getElementById('pageLocation').value || null,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                active: document.getElementById('activeBanner').checked
            };

            if (!data.title || !data.banner_type || !data.image_url) {
                alert('Title, Banner Type, and Image URL are required');
                return;
            }

            try {
                const url = isEdit ? `/api/admin/banners/${id}` : '/api/admin/banners';
                const method = isEdit ? 'PUT' : 'POST';

                console.log('Saving banner:', data);

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert(isEdit ? 'Banner updated successfully' : 'Banner created successfully');
                    closeModal();
                    await loadBanners();
                } else {
                    alert(result.message || 'Failed to save banner');
                }
            } catch (error) {
                console.error('Error saving banner:', error);
                alert('Failed to save banner');
            }
        }

        // Delete banner
        async function deleteBanner(id) {
            if (!confirm('Are you sure you want to delete this banner?')) return;

            try {
                console.log('Deleting banner:', id);
                const res = await fetch(`/api/admin/banners/${id}`, {
                    method: 'DELETE'
                });

                const result = await res.json();

                if (result.success) {
                    alert('Banner deleted successfully');
                    await loadBanners();
                } else {
                    alert(result.message || 'Failed to delete banner');
                }
            } catch (error) {
                console.error('Error deleting banner:', error);
                alert('Failed to delete banner');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('bannerModal').style.display = 'none';
        }

        // Image preview
        document.getElementById('imageUrl').addEventListener('input', function() {
            const url = this.value;
            const preview = document.getElementById('imagePreview');
            if (url) {
                preview.innerHTML = `<img src="${url}" style="max-width: 200px; max-height: 100px; object-fit: contain; border: 1px solid #ddd;">`;
            } else {
                preview.innerHTML = '';
            }
        });

        // Format date for datetime-local input
        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        }
    </script>
</body>
</html>
