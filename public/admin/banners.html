<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Banners Management - Shubha Kuteer Admin</title>
    <link rel="stylesheet" type="text/css" href="/admin/css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/animation.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/style.css">
    <link rel="stylesheet" href="/admin/font/fonts.css">
    <link rel="stylesheet" href="/admin/icon/style.css">
    <link rel="shortcut icon" href="/admin/images/favicon.png">
    <script>
        (async () => {
            try {
                const res = await fetch("/api/admin/auth/check", { credentials: "include" });
                if (!res.ok) window.location.href = "/admin/login.html";
            } catch {
                window.location.href = "/admin/login.html";
            }
        })();
    </script>
    <style>
        #bannerFormSection { display: none; }
        #bannerFormSection .cols { display: flex; gap: 20px; }
        #bannerFormSection .cols > fieldset { flex: 1; }
        #bannerFormSection textarea { height: 80px !important; }

        /* Filter tabs */
        .banner-filter-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .banner-filter-tab {
            padding: 6px 16px; border-radius: 20px; border: 1px solid #e0e0e0;
            background: #fff; cursor: pointer; font-size: 13px; font-weight: 500;
            transition: all 0.15s; color: #555;
        }
        .banner-filter-tab:hover { border-color: #2275fc; color: #2275fc; }
        .banner-filter-tab.active { background: #2275fc; color: #fff; border-color: #2275fc; }

        /* Banner card grid */
        .banner-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .banner-card {
            position: relative; border-radius: 12px; overflow: hidden;
            border: 1px solid #e8e8e8; background: #fff;
            transition: box-shadow 0.2s, transform 0.15s;
        }
        .banner-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .banner-card-img-wrap {
            width: 100%; height: 180px; overflow: hidden; background: #f5f5f5;
            display: flex; align-items: center; justify-content: center;
        }
        .banner-card-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .banner-card-body { padding: 12px 16px; }
        .banner-card-title { font-weight: 600; font-size: 14px; margin-bottom: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .banner-card-meta { font-size: 12px; color: #888; display: flex; gap: 8px; align-items: center; }
        .banner-card-meta span { display: inline-flex; align-items: center; gap: 3px; }
        .banner-card-footer {
            padding: 8px 16px 12px; display: flex; align-items: center;
            justify-content: space-between; border-top: 1px solid #f0f0f0;
        }
        .banner-card-status {
            padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        .status-active { background: #e6f9e6; color: #22c55e; }
        .status-inactive { background: #fff3e0; color: #f59e0b; }
        .banner-card-btns { display: flex; gap: 6px; }
        .banner-card-btns .bc-btn {
            width: 34px; height: 34px; border-radius: 50%; border: none;
            display: grid; place-items: center; cursor: pointer;
            font-size: 14px; transition: background 0.15s;
        }
        .bc-btn.bc-edit { background: #e8f0fe; color: #2275fc; }
        .bc-btn.bc-edit:hover { background: #d0e0fc; }
        .bc-btn.bc-del { background: #fff0f0; color: #ff4d4f; }
        .bc-btn.bc-del:hover { background: #ffd6d6; }
        .bc-btn.bc-eye { background: #f0f0f0; color: #555; }
        .bc-btn.bc-eye:hover { background: #e0e0e0; }

        /* Add banner card */
        .banner-add-card {
            border: 2px dashed #ddd; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 260px; cursor: pointer;
            transition: border-color 0.2s, background 0.2s; background: #fafafa;
        }
        .banner-add-card:hover { border-color: #2275fc; background: #f0f6ff; }
        .banner-add-card i { font-size: 36px; color: #bbb; margin-bottom: 8px; }
        .banner-add-card:hover i { color: #2275fc; }
        .banner-add-card span { color: #999; font-size: 14px; font-weight: 500; }
        .banner-add-card:hover span { color: #2275fc; }

        /* Section header */
        .banner-section { margin-bottom: 30px; }
        .banner-section-title {
            font-size: 16px; font-weight: 600; margin-bottom: 4px;
            display: flex; align-items: center; gap: 8px;
        }
        .banner-section-title .count {
            background: #e8f0fe; color: #2275fc; padding: 1px 8px;
            border-radius: 10px; font-size: 12px;
        }
        .banner-section-desc { font-size: 12px; color: #999; margin-bottom: 12px; }

        /* Upload drop zone */
        .upload-drop-zone {
            cursor: pointer; border: 2px dashed #ddd; border-radius: 8px;
            padding: 20px; text-align: center; min-height: 120px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: border-color 0.2s;
        }
        .upload-drop-zone:hover { border-color: #2275fc; }

        /* Image preview wrap */
        .img-preview-wrap {
            position: relative; display: inline-block; margin-top: 8px;
        }
        .img-preview-wrap img {
            max-width: 100%; max-height: 200px; object-fit: contain;
            border: 1px solid #ddd; border-radius: 8px; display: block;
        }

        /* X remove button - perfectly round */
        .img-remove-btn {
            position: absolute; top: -12px; right: -12px;
            background: #ff4d4f; color: #fff;
            border: 2px solid #fff; border-radius: 50%;
            width: 28px; height: 28px; padding: 0; margin: 0;
            aspect-ratio: 1 / 1;
            cursor: pointer; font-size: 18px;
            display: grid; place-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            z-index: 10; line-height: 1;
            font-family: Arial, Helvetica, sans-serif;
        }
        .img-remove-btn:hover { background: #d9363e; transform: scale(1.1); }

        /* Empty state */
        .empty-banner-state {
            text-align: center; padding: 40px 20px; color: #aaa;
        }
        .empty-banner-state i { font-size: 48px; margin-bottom: 12px; display: block; }
    </style>
</head>

<body class="body">

    <div id="wrapper">
        <div id="page" class="">
            <div class="layout-wrap">
                <!-- preload -->
                <div id="preload" class="preload-container">
                    <div class="preloading"><span></span></div>
                </div>

                <!-- section-menu-left -->
                <div class="section-menu-left">
                    <div class="box-logo w-120">
                        <a href="/admin/index.html" id="site-logo-inner">
                            <img class="" id="logo_header" alt="" src="/admin/images/logo/logo.png"
                                data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png">
                        </a>
                        <div class="button-show-hide">
                            <i class="icon-menu-left"></i>
                        </div>
                    </div>
                    <div class="section-menu-left-wrap">
                        <div class="center">
                            <div class="center-item">
                                <div class="center-heading">Main Home</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-grid"></i></div>
                                            <div class="text">Dashboard</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/index.html" class="">
                                                    <div class="text">Dashboard</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">All page</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-shopping-cart"></i></div>
                                            <div class="text">Ecommerce</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-product.html" class="">
                                                    <div class="text">Add Product</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/product-list.html" class="">
                                                    <div class="text">Product List</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-layers"></i></div>
                                            <div class="text">Category</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/category-list.html" class="">
                                                    <div class="text">Category list</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/new-category.html" class="">
                                                    <div class="text">New category</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-box"></i></div>
                                            <div class="text">Attributes</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/attributes.html" class="">
                                                    <div class="text">Attributes</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-attributes.html" class="">
                                                    <div class="text">Add attributes</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-file-plus"></i></div>
                                            <div class="text">Order</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/order-list.html" class="">
                                                    <div class="text">Order list</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-tag"></i></div>
                                            <div class="text">Marketing</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/banners.html" class="active">
                                                    <div class="text">Banners</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/coupons.html" class="">
                                                    <div class="text">Coupons</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-user"></i></div>
                                            <div class="text">User</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/all-user.html" class="">
                                                    <div class="text">All user</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-new-user.html" class="">
                                                    <div class="text">Add new user</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li></ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">Setting</div>
                                <ul class="menu-list">
                                    <li class="menu-item">
                                        <a href="/admin/setting.html" class="">
                                            <div class="icon"><i class="icon-settings"></i></div>
                                            <div class="text">Setting</div>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">Connect us</div>
                                <ul class="wg-social">
                                    <li><a href="#"><i class="icon-facebook"></i></a></li>
                                    <li class="active"><a href="#"><i class="icon-twitter"></i></a></li>
                                    <li><a href="#"><i class="icon-linkedin"></i></a></li>
                                    <li><a href="#"><i class="icon-instagram"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="bot text-center">
                            <div class="wrap">
                                <div class="mb-20">
                                    <img src="/admin/images/menu-left/img-bot.png" alt="">
                                </div>
                                <div class="mb-20">
                                    <h6>Hi, how can we help?</h6>
                                    <div class="text">Contact us if you have any assistance, we will contact you as soon as possible</div>
                                </div>
                                <a href="mailto:parthbuilds@gmail.com" class="tf-button w-full">Contact</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- section-content-right -->
                <div class="section-content-right">
                    <!-- header-dashboard -->
                    <div class="header-dashboard">
                        <div class="wrap">
                            <div class="header-left">
                                <a href="/admin/index.html">
                                    <img class="" id="logo_header_mobile" alt="" src="/admin/images/logo/logo.png"
                                        data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png"
                                        data-width="154px" data-height="52px" data-retina="images/logo/logo@2x.png">
                                </a>
                                <div class="button-show-hide">
                                    <i class="icon-menu-left"></i>
                                </div>
                                <form class="form-search flex-grow">
                                    <fieldset class="name">
                                        <input type="text" placeholder="Search here..." class="show-search" name="name"
                                            tabindex="2" value="" aria-required="true" required="">
                                    </fieldset>
                                    <div class="button-submit">
                                        <button class="" type="submit"><i class="icon-search"></i></button>
                                    </div>
                                </form>
                            </div>
                            <div class="header-grid">
                                <div class="header-item country">
                                    <select class="image-select no-text">
                                        <option data-thumbnail="images/country/3.png">ENG</option>
                                        <option data-thumbnail="images/country/9.png">VIE</option>
                                    </select>
                                </div>
                                <div class="header-item button-dark-light">
                                    <i class="icon-moon"></i>
                                </div>
                                <div class="popup-wrap user type-header">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button"
                                            id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="header-user wg-user">
                                                <span class="image">
                                                    <img src="/admin/images/avatar/user-1.png" alt="">
                                                </span>
                                                <span class="flex flex-column">
                                                    <span id="admin-name" class="body-title mb-2">Loading...</span>
                                                    <span id="admin-role" class="text-tiny">Admin</span>
                                                </span>
                                            </span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end has-content"
                                            aria-labelledby="dropdownMenuButton3">
                                            <li>
                                                <a href="#" class="user-item">
                                                    <div class="icon"><i class="icon-user"></i></div>
                                                    <div class="body-title-2">Account</div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="/admin/setting.html" class="user-item">
                                                    <div class="icon"><i class="icon-settings"></i></div>
                                                    <div class="body-title-2">Setting</div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="/admin/login.html" class="user-item">
                                                    <div class="icon"><i class="icon-log-out"></i></div>
                                                    <div class="body-title-2">Log out</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- main-content -->
                    <div class="main-content">
                        <div class="main-content-inner">
                            <div class="main-content-wrap">
                                <div class="flex items-center flex-wrap justify-between gap20 mb-27">
                                    <h3>Banners Management</h3>
                                    <ul class="breadcrumbs flex items-center flex-wrap justify-start gap10">
                                        <li><a href="/admin/index.html"><div class="text-tiny">Dashboard</div></a></li>
                                        <li><i class="icon-chevron-right"></i></li>
                                        <li><a href="#"><div class="text-tiny">Marketing</div></a></li>
                                        <li><i class="icon-chevron-right"></i></li>
                                        <li><div class="text-tiny">Banners</div></li>
                                    </ul>
                                </div>

                                <!-- banner-form-section -->
                                <div id="bannerFormSection" class="wg-box mb-20">
                                    <div class="flex items-center justify-between gap10 mb-20">
                                        <h5 id="modalTitle">Add New Banner</h5>
                                    </div>
                                    <form id="bannerForm" class="form-add-product">
                                        <input type="hidden" id="bannerId">

                                        <div class="cols">
                                            <fieldset>
                                                <div class="body-title mb-10">Title <span class="tf-color-1">*</span></div>
                                                <input type="text" id="bannerTitle" required placeholder="e.g., Summer Sale Banner">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Banner Type <span class="tf-color-1">*</span></div>
                                                <div class="select">
                                                    <select id="bannerType" required>
                                                        <option value="hero">Hero (Main Slider)</option>
                                                        <option value="promotional">Promotional (Offer Cards)</option>
                                                        <option value="category">Category Banner</option>
                                                        <option value="sidebar">Sidebar</option>
                                                        <option value="footer">Footer</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Page Location <span class="tf-color-1">*</span></div>
                                                <div class="select">
                                                    <select id="pageLocation">
                                                        <option value="home">Home Page</option>
                                                        <option value="shop">Shop Page</option>
                                                        <option value="">All Pages</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Position (Order)</div>
                                                <input type="number" id="position" min="0" value="0" placeholder="Lower = first">
                                            </fieldset>
                                        </div>

                                        <fieldset class="mt-20">
                                            <div class="body-title mb-10">Description</div>
                                            <textarea id="bannerDescription" placeholder="Banner description..."></textarea>
                                        </fieldset>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Banner Image <span class="tf-color-1">*</span></div>
                                                <input type="hidden" id="imageUrl">
                                                <div id="imageUploadArea">
                                                    <div class="upload-drop-zone" id="mainImageUpload">
                                                        <i class="icon-upload-cloud" style="font-size:28px; color:#999; margin-bottom:8px;"></i>
                                                        <div class="body-text" style="color:#999;">Click to upload banner image</div>
                                                        <input type="file" id="mainImageFile" accept="image/*" style="display:none;">
                                                    </div>
                                                </div>
                                                <div id="imagePreview" class="img-preview-wrap" style="display:none;">
                                                    <img id="imagePreviewImg" src="">
                                                    <button type="button" class="img-remove-btn" onclick="removeMainImage()" title="Remove image">&times;</button>
                                                </div>
                                                <div id="mainImageProgress" style="display:none;" class="mt-5">
                                                    <div style="background:#eee; border-radius:4px; height:6px; overflow:hidden;">
                                                        <div id="mainImageProgressBar" style="background:#2275fc; height:100%; width:0%; transition: width 0.3s;"></div>
                                                    </div>
                                                    <div class="text-tiny mt-5" id="mainImageStatus">Uploading...</div>
                                                </div>
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Mobile Banner Image</div>
                                                <input type="hidden" id="mobileImageUrl">
                                                <div id="mobileImageUploadArea">
                                                    <div class="upload-drop-zone" id="mobileImageUpload">
                                                        <i class="icon-upload-cloud" style="font-size:28px; color:#999; margin-bottom:8px;"></i>
                                                        <div class="body-text" style="color:#999;">Click to upload mobile image</div>
                                                        <input type="file" id="mobileImageFile" accept="image/*" style="display:none;">
                                                    </div>
                                                </div>
                                                <div id="mobileImagePreview" class="img-preview-wrap" style="display:none;">
                                                    <img id="mobileImagePreviewImg" src="">
                                                    <button type="button" class="img-remove-btn" onclick="removeMobileImage()" title="Remove image">&times;</button>
                                                </div>
                                                <div id="mobileImageProgress" style="display:none;" class="mt-5">
                                                    <div style="background:#eee; border-radius:4px; height:6px; overflow:hidden;">
                                                        <div id="mobileImageProgressBar" style="background:#2275fc; height:100%; width:0%; transition: width 0.3s;"></div>
                                                    </div>
                                                    <div class="text-tiny mt-5" id="mobileImageStatus">Uploading...</div>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Link URL</div>
                                                <input type="text" id="linkUrl" placeholder="e.g., /shop.html?cat=Bedsheets">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Link Target</div>
                                                <div class="select">
                                                    <select id="linkTarget">
                                                        <option value="_self">Same Window</option>
                                                        <option value="_blank">New Window</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Start Date</div>
                                                <input type="datetime-local" id="startDate">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">End Date</div>
                                                <input type="datetime-local" id="endDate">
                                            </fieldset>
                                        </div>

                                        <fieldset class="mt-20">
                                            <label><input type="checkbox" id="activeBanner" checked> Active</label>
                                        </fieldset>

                                        <div class="cols gap10 mt-20">
                                            <button type="button" class="tf-button w-full" onclick="closeFormSection()">Cancel</button>
                                            <button type="button" class="tf-button style-1 w-full" onclick="saveBanner()">Save Banner</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- banner visual grid -->
                                <div class="wg-box mb-20">
                                    <div class="flex items-center justify-between gap10 flex-wrap mb-14">
                                        <div>
                                            <h5>Website Banners</h5>
                                            <div class="text-tiny mt-4">Click a banner to edit, or add new banners to each section</div>
                                        </div>
                                        <button onclick="showAddModal()" class="tf-button style-1"><i class="icon-plus"></i>Add New Banner</button>
                                    </div>

                                    <div class="banner-filter-tabs mb-14" id="filterTabs">
                                        <div class="banner-filter-tab active" data-filter="all">All</div>
                                        <div class="banner-filter-tab" data-filter="home">Home Page</div>
                                        <div class="banner-filter-tab" data-filter="shop">Shop Page</div>
                                        <div class="banner-filter-tab" data-filter="global">All Pages</div>
                                    </div>

                                    <div id="bannerSections">
                                        <div class="empty-banner-state">
                                            <i class="icon-image"></i>
                                            <div>Loading banners...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- bottom-page -->
                        <div class="bottom-page">
                            <div class="body-text">Copyright Â© 2024 Shubha Kuteer Design with</div>
                            <i class="icon-heart"></i>
                            <div class="body-text">by <a href="https://aptmedia.in">APT Media</a> All rights reserved.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Cloudinary config
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dknjr0tj2/upload";
        const UPLOAD_PRESET = "unsigned_products";

        let allBanners = [];
        let activeFilter = 'all';

        // Page location config
        const PAGE_SECTIONS = {
            home: { label: 'Home Page Banners', desc: 'Banners shown on the home page (hero sliders, promotional cards, etc.)' },
            shop: { label: 'Shop Page Banners', desc: 'Banners shown on the shop/product listing page' },
            '':   { label: 'All Pages (Global)', desc: 'Banners shown across all pages of the website' }
        };

        // Load admin data
        async function loadAdminData() {
            try {
                const res = await fetch("/api/admin/users/me");
                if (!res.ok) throw new Error("Failed to fetch admin");
                const data = await res.json();
                document.getElementById("admin-name").textContent = data.admin.name;
                document.getElementById("admin-role").textContent = data.admin.role;
            } catch (err) {
                console.error("Error loading admin:", err);
            }
        }

        // Load banners on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAdminData();
            await loadBanners();
            initFilterTabs();
        });

        // Load all banners
        async function loadBanners() {
            try {
                const res = await fetch('/api/admin/banners');
                if (!res.ok) throw new Error('Failed to load banners');
                const data = await res.json();
                allBanners = data.banners || [];
                renderBannerGrid();
            } catch (error) {
                console.error('Error loading banners:', error);
                document.getElementById('bannerSections').innerHTML =
                    '<div class="empty-banner-state"><i class="icon-alert-triangle"></i><div>Failed to load banners</div></div>';
            }
        }

        // Filter tabs
        function initFilterTabs() {
            document.querySelectorAll('.banner-filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.banner-filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    activeFilter = tab.dataset.filter;
                    renderBannerGrid();
                });
            });
        }

        // Render visual banner grid grouped by section
        function renderBannerGrid() {
            const container = document.getElementById('bannerSections');

            // Group banners by page_location
            const grouped = {};
            allBanners.forEach(b => {
                const loc = b.page_location || '';
                if (!grouped[loc]) grouped[loc] = [];
                grouped[loc].push(b);
            });

            // Sort each group by position
            Object.keys(grouped).forEach(k => {
                grouped[k].sort((a, b) => (a.position || 0) - (b.position || 0));
            });

            // Determine which sections to show
            let sectionsToRender = [];
            if (activeFilter === 'all') {
                // Show all known sections + any extra locations from data
                const allLocs = new Set([...Object.keys(PAGE_SECTIONS), ...Object.keys(grouped)]);
                allLocs.forEach(loc => sectionsToRender.push(loc));
            } else if (activeFilter === 'global') {
                sectionsToRender = [''];
            } else {
                sectionsToRender = [activeFilter];
            }

            if (allBanners.length === 0 && activeFilter === 'all') {
                container.innerHTML = `
                    <div class="empty-banner-state">
                        <i class="icon-image"></i>
                        <div class="body-title mb-10">No banners yet</div>
                        <div class="text-tiny mb-20">Click "Add New Banner" to create your first banner</div>
                    </div>`;
                return;
            }

            let html = '';
            sectionsToRender.forEach(loc => {
                const banners = grouped[loc] || [];
                const section = PAGE_SECTIONS[loc] || { label: loc || 'Other', desc: '' };

                // Skip empty sections when filtered (except the active filter)
                if (activeFilter !== 'all' && banners.length === 0) {
                    // Still show the section with just the add card
                }

                html += `<div class="banner-section">`;
                html += `<div class="banner-section-title">${section.label} <span class="count">${banners.length}</span></div>`;
                if (section.desc) html += `<div class="banner-section-desc">${section.desc}</div>`;
                html += `<div class="banner-grid">`;

                // Render each banner as a card
                banners.forEach(banner => {
                    const statusCls = banner.active ? 'status-active' : 'status-inactive';
                    const statusTxt = banner.active ? 'Active' : 'Inactive';
                    const typeLbl = banner.banner_type.charAt(0).toUpperCase() + banner.banner_type.slice(1);
                    html += `
                        <div class="banner-card" data-id="${banner.id}">
                            <div class="banner-card-img-wrap">
                                <img src="${banner.image_url}" alt="${banner.title || ''}" onerror="this.src='/admin/images/products/default-order.png'">
                            </div>
                            <div class="banner-card-body">
                                <div class="banner-card-title">${banner.title || 'Untitled'}</div>
                                <div class="banner-card-meta">
                                    <span><i class="icon-tag"></i> ${typeLbl}</span>
                                    <span><i class="icon-layers"></i> Pos ${banner.position || 0}</span>
                                </div>
                            </div>
                            <div class="banner-card-footer">
                                <span class="banner-card-status ${statusCls}">${statusTxt}</span>
                                <div class="banner-card-btns">
                                    <button class="bc-btn bc-edit" onclick="event.stopPropagation(); editBanner(${banner.id})" title="Edit"><i class="icon-edit-3"></i></button>
                                    <button class="bc-btn bc-eye" onclick="event.stopPropagation(); previewBanner(${banner.id})" title="Preview"><i class="icon-eye"></i></button>
                                    <button class="bc-btn bc-del" onclick="event.stopPropagation(); deleteBanner(${banner.id})" title="Delete"><i class="icon-trash-2"></i></button>
                                </div>
                            </div>
                        </div>`;
                });

                // Add card at the end
                html += `
                    <div class="banner-add-card" onclick="showAddModal('${loc}')">
                        <i class="icon-plus"></i>
                        <span>Add Banner</span>
                    </div>`;

                html += `</div></div>`;
            });

            container.innerHTML = html;

            // Make banner cards clickable to edit
            container.querySelectorAll('.banner-card').forEach(card => {
                card.addEventListener('click', () => {
                    const id = parseInt(card.dataset.id);
                    if (id) editBanner(id);
                });
                card.style.cursor = 'pointer';
            });
        }

        // --- Cloudinary Upload Helper ---
        async function uploadToCloudinary(file, progressBarId, statusId) {
            if (!file) return null;
            const progressBar = document.getElementById(progressBarId);
            const statusEl = document.getElementById(statusId);

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open("POST", CLOUDINARY_URL);
                xhr.upload.addEventListener("progress", (e) => {
                    if (e.lengthComputable && progressBar) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = pct + '%';
                        if (statusEl) statusEl.textContent = `Uploading... ${pct}%`;
                    }
                });
                xhr.addEventListener("load", () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const data = JSON.parse(xhr.responseText);
                        if (statusEl) statusEl.textContent = 'Upload complete!';
                        resolve(data.secure_url);
                    } else {
                        if (statusEl) statusEl.textContent = 'Upload failed!';
                        reject(new Error('Upload failed: ' + xhr.statusText));
                    }
                });
                xhr.addEventListener("error", () => {
                    if (statusEl) statusEl.textContent = 'Upload error!';
                    reject(new Error('Network error during upload'));
                });
                xhr.send(formData);
            });
        }

        // Extract Cloudinary public_id from URL
        function getCloudinaryPublicId(url) {
            if (!url || !url.includes('cloudinary')) return null;
            try {
                const parts = url.split('/upload/');
                if (parts.length < 2) return null;
                let path = parts[1];
                path = path.replace(/^v\d+\//, '');
                path = path.replace(/\.[^/.]+$/, '');
                return path;
            } catch (e) { return null; }
        }

        // Delete image from Cloudinary
        async function deleteFromCloudinary(url) {
            const publicId = getCloudinaryPublicId(url);
            if (!publicId) return;
            try {
                await fetch('/api/admin/cloudinary/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ public_id: publicId })
                });
            } catch (e) {
                console.error('Failed to delete from Cloudinary:', e);
            }
        }

        // --- Image Preview Helpers ---
        function showImagePreview(url, previewId, previewImgId, uploadAreaId) {
            document.getElementById(previewImgId).src = url;
            document.getElementById(previewId).style.display = 'inline-block';
            document.getElementById(uploadAreaId).style.display = 'none';
        }
        function hideImagePreview(previewId, uploadAreaId, hiddenInputId, progressId) {
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(uploadAreaId).style.display = 'block';
            document.getElementById(hiddenInputId).value = '';
            if (progressId) document.getElementById(progressId).style.display = 'none';
        }

        // Remove images (with Cloudinary delete)
        async function removeMainImage() {
            const url = document.getElementById('imageUrl').value;
            if (url) await deleteFromCloudinary(url);
            hideImagePreview('imagePreview', 'imageUploadArea', 'imageUrl', 'mainImageProgress');
        }
        async function removeMobileImage() {
            const url = document.getElementById('mobileImageUrl').value;
            if (url) await deleteFromCloudinary(url);
            hideImagePreview('mobileImagePreview', 'mobileImageUploadArea', 'mobileImageUrl', 'mobileImageProgress');
        }

        // --- File Input Handlers ---
        document.getElementById('mainImageUpload').addEventListener('click', () => {
            document.getElementById('mainImageFile').click();
        });
        document.getElementById('mobileImageUpload').addEventListener('click', () => {
            document.getElementById('mobileImageFile').click();
        });

        document.getElementById('mainImageFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('mainImageProgress').style.display = 'block';
            document.getElementById('mainImageProgressBar').style.width = '0%';
            try {
                const url = await uploadToCloudinary(file, 'mainImageProgressBar', 'mainImageStatus');
                if (url) {
                    document.getElementById('imageUrl').value = url;
                    showImagePreview(url, 'imagePreview', 'imagePreviewImg', 'imageUploadArea');
                }
            } catch (err) { alert('Failed to upload: ' + err.message); }
            e.target.value = '';
        });

        document.getElementById('mobileImageFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('mobileImageProgress').style.display = 'block';
            document.getElementById('mobileImageProgressBar').style.width = '0%';
            try {
                const url = await uploadToCloudinary(file, 'mobileImageProgressBar', 'mobileImageStatus');
                if (url) {
                    document.getElementById('mobileImageUrl').value = url;
                    showImagePreview(url, 'mobileImagePreview', 'mobileImagePreviewImg', 'mobileImageUploadArea');
                }
            } catch (err) { alert('Failed to upload: ' + err.message); }
            e.target.value = '';
        });

        // Show add modal (optionally pre-select page location)
        function showAddModal(pageLocation) {
            document.getElementById('modalTitle').textContent = 'Add New Banner';
            document.getElementById('bannerForm').reset();
            document.getElementById('bannerId').value = '';
            document.getElementById('activeBanner').checked = true;
            if (pageLocation !== undefined) {
                document.getElementById('pageLocation').value = pageLocation;
            }
            hideImagePreview('imagePreview', 'imageUploadArea', 'imageUrl', 'mainImageProgress');
            hideImagePreview('mobileImagePreview', 'mobileImageUploadArea', 'mobileImageUrl', 'mobileImageProgress');
            document.getElementById('bannerFormSection').style.display = 'block';
            document.getElementById('bannerFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Edit banner
        function editBanner(id) {
            const banner = allBanners.find(b => b.id === id);
            if (!banner) return;

            document.getElementById('modalTitle').textContent = 'Edit Banner';
            document.getElementById('bannerId').value = banner.id;
            document.getElementById('bannerTitle').value = banner.title || '';
            document.getElementById('bannerDescription').value = banner.description || '';
            document.getElementById('bannerType').value = banner.banner_type;
            document.getElementById('imageUrl').value = banner.image_url;
            document.getElementById('mobileImageUrl').value = banner.mobile_image_url || '';
            document.getElementById('linkUrl').value = banner.link_url || '';
            document.getElementById('linkTarget').value = banner.link_target || '_self';
            document.getElementById('position').value = banner.position;
            document.getElementById('pageLocation').value = banner.page_location || '';
            document.getElementById('startDate').value = formatDateTimeLocal(banner.start_date);
            document.getElementById('endDate').value = formatDateTimeLocal(banner.end_date);
            document.getElementById('activeBanner').checked = banner.active;

            if (banner.image_url) {
                showImagePreview(banner.image_url, 'imagePreview', 'imagePreviewImg', 'imageUploadArea');
            } else {
                hideImagePreview('imagePreview', 'imageUploadArea', 'imageUrl', 'mainImageProgress');
            }
            if (banner.mobile_image_url) {
                showImagePreview(banner.mobile_image_url, 'mobileImagePreview', 'mobileImagePreviewImg', 'mobileImageUploadArea');
            } else {
                hideImagePreview('mobileImagePreview', 'mobileImageUploadArea', 'mobileImageUrl', 'mobileImageProgress');
            }

            document.getElementById('bannerFormSection').style.display = 'block';
            document.getElementById('bannerFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Preview banner
        function previewBanner(id) {
            const banner = allBanners.find(b => b.id === id);
            if (banner && banner.image_url) window.open(banner.image_url, '_blank');
        }

        // Save banner
        async function saveBanner() {
            const id = document.getElementById('bannerId').value;
            const isEdit = !!id;
            const imageUrlVal = document.getElementById('imageUrl').value;

            const data = {
                title: document.getElementById('bannerTitle').value,
                description: document.getElementById('bannerDescription').value,
                banner_type: document.getElementById('bannerType').value,
                image_url: imageUrlVal,
                mobile_image_url: document.getElementById('mobileImageUrl').value || null,
                link_url: document.getElementById('linkUrl').value || null,
                link_target: document.getElementById('linkTarget').value,
                position: parseInt(document.getElementById('position').value) || 0,
                page_location: document.getElementById('pageLocation').value || null,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                active: document.getElementById('activeBanner').checked
            };

            if (!data.title) { alert('Please enter a banner title'); return; }
            if (!data.image_url) { alert('Please upload a banner image first'); return; }

            try {
                const url = isEdit ? `/api/admin/banners/${id}` : '/api/admin/banners';
                const method = isEdit ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method, headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const text = await res.text();
                let result;
                try { result = JSON.parse(text); } catch (e) {
                    throw new Error('Invalid server response');
                }
                if (result.success) {
                    alert(isEdit ? 'Banner updated!' : 'Banner created!');
                    closeFormSection();
                    await loadBanners();
                } else {
                    alert('Error: ' + (result.message || result.error || 'Unknown'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save: ' + error.message);
            }
        }

        // Delete banner (+ Cloudinary cleanup)
        async function deleteBanner(id) {
            if (!confirm('Delete this banner? Images will also be removed from Cloudinary.')) return;
            try {
                const banner = allBanners.find(b => b.id === id);
                const res = await fetch(`/api/admin/banners/${id}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    if (banner) {
                        if (banner.image_url) await deleteFromCloudinary(banner.image_url);
                        if (banner.mobile_image_url) await deleteFromCloudinary(banner.mobile_image_url);
                    }
                    await loadBanners();
                } else {
                    alert(result.message || 'Failed to delete');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete banner');
            }
        }

        // Close form
        function closeFormSection() {
            document.getElementById('bannerFormSection').style.display = 'none';
        }

        // Date helpers
        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const d = new Date(dateString);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-IN');
        }
    </script>

    <script src="/admin/js/jquery.min.js"></script>
    <script src="/admin/js/bootstrap.min.js"></script>
    <script src="/admin/js/bootstrap-select.min.js"></script>
    <script src="/admin/js/main.js"></script>
</body>
</html>
