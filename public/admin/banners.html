<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Banners Management - Shubha Kuteer Admin</title>
    <link rel="stylesheet" type="text/css" href="/admin/css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/animation.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/style.css">
    <link rel="stylesheet" href="/admin/font/fonts.css">
    <link rel="stylesheet" href="/admin/icon/style.css">
    <link rel="shortcut icon" href="/admin/images/favicon.png">
    <script>
        (async () => {
            try {
                const res = await fetch("/api/admin/auth/check", { credentials: "include" });
                if (!res.ok) window.location.href = "/admin/login.html";
            } catch {
                window.location.href = "/admin/login.html";
            }
        })();
    </script>
    <style>
        #bannerFormSection { display: none; }
        #bannerFormSection .cols { display: flex; gap: 20px; }
        #bannerFormSection .cols > fieldset { flex: 1; }
        #bannerFormSection textarea { height: 80px !important; }
        .img-preview-wrap {
            position: relative;
            display: inline-block;
            margin-top: 8px;
        }
        .img-preview-wrap img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: block;
        }
        .img-remove-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff4d4f;
            color: #fff;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .img-remove-btn:hover {
            background: #d9363e;
            transform: scale(1.1);
        }
        .upload-drop-zone {
            cursor: pointer;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
        }
        .upload-drop-zone:hover {
            border-color: #2275fc;
        }
    </style>
</head>

<body class="body">

    <div id="wrapper">
        <div id="page" class="">
            <div class="layout-wrap">
                <!-- preload -->
                <div id="preload" class="preload-container">
                    <div class="preloading"><span></span></div>
                </div>

                <!-- section-menu-left -->
                <div class="section-menu-left">
                    <div class="box-logo w-120">
                        <a href="/admin/index.html" id="site-logo-inner">
                            <img class="" id="logo_header" alt="" src="/admin/images/logo/logo.png"
                                data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png">
                        </a>
                        <div class="button-show-hide">
                            <i class="icon-menu-left"></i>
                        </div>
                    </div>
                    <div class="section-menu-left-wrap">
                        <div class="center">
                            <div class="center-item">
                                <div class="center-heading">Main Home</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-grid"></i></div>
                                            <div class="text">Dashboard</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/index.html" class="">
                                                    <div class="text">Dashboard</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">All page</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-shopping-cart"></i></div>
                                            <div class="text">Ecommerce</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-product.html" class="">
                                                    <div class="text">Add Product</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/product-list.html" class="">
                                                    <div class="text">Product List</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-layers"></i></div>
                                            <div class="text">Category</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/category-list.html" class="">
                                                    <div class="text">Category list</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/new-category.html" class="">
                                                    <div class="text">New category</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-box"></i></div>
                                            <div class="text">Attributes</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/attributes.html" class="">
                                                    <div class="text">Attributes</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-attributes.html" class="">
                                                    <div class="text">Add attributes</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-file-plus"></i></div>
                                            <div class="text">Order</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/order-list.html" class="">
                                                    <div class="text">Order list</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-tag"></i></div>
                                            <div class="text">Marketing</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/banners.html" class="active">
                                                    <div class="text">Banners</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/coupons.html" class="">
                                                    <div class="text">Coupons</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-user"></i></div>
                                            <div class="text">User</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item">
                                                <a href="/admin/all-user.html" class="">
                                                    <div class="text">All user</div>
                                                </a>
                                            </li>
                                            <li class="sub-menu-item">
                                                <a href="/admin/add-new-user.html" class="">
                                                    <div class="text">Add new user</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </li></ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">Setting</div>
                                <ul class="menu-list">
                                    <li class="menu-item">
                                        <a href="/admin/setting.html" class="">
                                            <div class="icon"><i class="icon-settings"></i></div>
                                            <div class="text">Setting</div>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">Connect us</div>
                                <ul class="wg-social">
                                    <li><a href="#"><i class="icon-facebook"></i></a></li>
                                    <li class="active"><a href="#"><i class="icon-twitter"></i></a></li>
                                    <li><a href="#"><i class="icon-linkedin"></i></a></li>
                                    <li><a href="#"><i class="icon-instagram"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="bot text-center">
                            <div class="wrap">
                                <div class="mb-20">
                                    <img src="/admin/images/menu-left/img-bot.png" alt="">
                                </div>
                                <div class="mb-20">
                                    <h6>Hi, how can we help?</h6>
                                    <div class="text">Contact us if you have any assistance, we will contact you as soon as possible</div>
                                </div>
                                <a href="mailto:parthbuilds@gmail.com" class="tf-button w-full">Contact</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- section-content-right -->
                <div class="section-content-right">
                    <!-- header-dashboard -->
                    <div class="header-dashboard">
                        <div class="wrap">
                            <div class="header-left">
                                <a href="/admin/index.html">
                                    <img class="" id="logo_header_mobile" alt="" src="/admin/images/logo/logo.png"
                                        data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png"
                                        data-width="154px" data-height="52px" data-retina="images/logo/logo@2x.png">
                                </a>
                                <div class="button-show-hide">
                                    <i class="icon-menu-left"></i>
                                </div>
                                <form class="form-search flex-grow">
                                    <fieldset class="name">
                                        <input type="text" placeholder="Search here..." class="show-search" name="name"
                                            tabindex="2" value="" aria-required="true" required="">
                                    </fieldset>
                                    <div class="button-submit">
                                        <button class="" type="submit"><i class="icon-search"></i></button>
                                    </div>
                                </form>
                            </div>
                            <div class="header-grid">
                                <div class="header-item country">
                                    <select class="image-select no-text">
                                        <option data-thumbnail="images/country/3.png">ENG</option>
                                        <option data-thumbnail="images/country/9.png">VIE</option>
                                    </select>
                                </div>
                                <div class="header-item button-dark-light">
                                    <i class="icon-moon"></i>
                                </div>
                                <div class="popup-wrap user type-header">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button"
                                            id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="header-user wg-user">
                                                <span class="image">
                                                    <img src="/admin/images/avatar/user-1.png" alt="">
                                                </span>
                                                <span class="flex flex-column">
                                                    <span id="admin-name" class="body-title mb-2">Loading...</span>
                                                    <span id="admin-role" class="text-tiny">Admin</span>
                                                </span>
                                            </span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end has-content"
                                            aria-labelledby="dropdownMenuButton3">
                                            <li>
                                                <a href="#" class="user-item">
                                                    <div class="icon"><i class="icon-user"></i></div>
                                                    <div class="body-title-2">Account</div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="/admin/setting.html" class="user-item">
                                                    <div class="icon"><i class="icon-settings"></i></div>
                                                    <div class="body-title-2">Setting</div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="/admin/login.html" class="user-item">
                                                    <div class="icon"><i class="icon-log-out"></i></div>
                                                    <div class="body-title-2">Log out</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- main-content -->
                    <div class="main-content">
                        <div class="main-content-inner">
                            <div class="main-content-wrap">
                                <div class="flex items-center flex-wrap justify-between gap20 mb-27">
                                    <h3>Banners Management</h3>
                                    <ul class="breadcrumbs flex items-center flex-wrap justify-start gap10">
                                        <li><a href="/admin/index.html"><div class="text-tiny">Dashboard</div></a></li>
                                        <li><i class="icon-chevron-right"></i></li>
                                        <li><a href="#"><div class="text-tiny">Marketing</div></a></li>
                                        <li><i class="icon-chevron-right"></i></li>
                                        <li><div class="text-tiny">Banners</div></li>
                                    </ul>
                                </div>

                                <!-- banner-form-section -->
                                <div id="bannerFormSection" class="wg-box mb-20">
                                    <div class="flex items-center justify-between gap10 mb-20">
                                        <h5 id="modalTitle">Add New Banner</h5>
                                    </div>
                                    <form id="bannerForm" class="form-add-product">
                                        <input type="hidden" id="bannerId">

                                        <div class="cols">
                                            <fieldset>
                                                <div class="body-title mb-10">Title <span class="tf-color-1">*</span></div>
                                                <input type="text" id="bannerTitle" required placeholder="e.g., Summer Sale">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Banner Type <span class="tf-color-1">*</span></div>
                                                <div class="select">
                                                    <select id="bannerType" required>
                                                        <option value="hero">Hero</option>
                                                        <option value="category">Category</option>
                                                        <option value="promotional">Promotional</option>
                                                        <option value="sidebar">Sidebar</option>
                                                        <option value="footer">Footer</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <fieldset class="mt-20">
                                            <div class="body-title mb-10">Description</div>
                                            <textarea id="bannerDescription" placeholder="Banner description..."></textarea>
                                        </fieldset>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Banner Image <span class="tf-color-1">*</span></div>
                                                <input type="hidden" id="imageUrl">
                                                <div id="imageUploadArea">
                                                    <div class="upload-drop-zone" id="mainImageUpload">
                                                        <i class="icon-upload-cloud" style="font-size:28px; color:#999; margin-bottom:8px;"></i>
                                                        <div class="body-text" style="color:#999;">Click to upload banner image</div>
                                                        <input type="file" id="mainImageFile" accept="image/*" style="display:none;">
                                                    </div>
                                                </div>
                                                <div id="imagePreview" class="img-preview-wrap" style="display:none;">
                                                    <img id="imagePreviewImg" src="">
                                                    <button type="button" class="img-remove-btn" onclick="removeMainImage()" title="Remove image">&times;</button>
                                                </div>
                                                <div id="mainImageProgress" style="display:none;" class="mt-5">
                                                    <div style="background:#eee; border-radius:4px; height:6px; overflow:hidden;">
                                                        <div id="mainImageProgressBar" style="background:#2275fc; height:100%; width:0%; transition: width 0.3s;"></div>
                                                    </div>
                                                    <div class="text-tiny mt-5" id="mainImageStatus">Uploading...</div>
                                                </div>
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Mobile Banner Image</div>
                                                <input type="hidden" id="mobileImageUrl">
                                                <div id="mobileImageUploadArea">
                                                    <div class="upload-drop-zone" id="mobileImageUpload">
                                                        <i class="icon-upload-cloud" style="font-size:28px; color:#999; margin-bottom:8px;"></i>
                                                        <div class="body-text" style="color:#999;">Click to upload mobile image</div>
                                                        <input type="file" id="mobileImageFile" accept="image/*" style="display:none;">
                                                    </div>
                                                </div>
                                                <div id="mobileImagePreview" class="img-preview-wrap" style="display:none;">
                                                    <img id="mobileImagePreviewImg" src="">
                                                    <button type="button" class="img-remove-btn" onclick="removeMobileImage()" title="Remove image">&times;</button>
                                                </div>
                                                <div id="mobileImageProgress" style="display:none;" class="mt-5">
                                                    <div style="background:#eee; border-radius:4px; height:6px; overflow:hidden;">
                                                        <div id="mobileImageProgressBar" style="background:#2275fc; height:100%; width:0%; transition: width 0.3s;"></div>
                                                    </div>
                                                    <div class="text-tiny mt-5" id="mobileImageStatus">Uploading...</div>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Link URL</div>
                                                <input type="text" id="linkUrl" placeholder="https://example.com/products">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Link Target</div>
                                                <div class="select">
                                                    <select id="linkTarget">
                                                        <option value="_self">Same Window (_self)</option>
                                                        <option value="_blank">New Window (_blank)</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Position (Order)</div>
                                                <input type="number" id="position" min="0" value="0" placeholder="Lower numbers appear first">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">Page Location</div>
                                                <div class="select">
                                                    <select id="pageLocation">
                                                        <option value="">All Pages</option>
                                                        <option value="home">Home</option>
                                                        <option value="shop">Shop</option>
                                                        <option value="category:bed-linen">Bed Linen</option>
                                                        <option value="category:dog-food">Dog Food</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                        </div>

                                        <div class="cols mt-20">
                                            <fieldset>
                                                <div class="body-title mb-10">Start Date</div>
                                                <input type="datetime-local" id="startDate">
                                            </fieldset>
                                            <fieldset>
                                                <div class="body-title mb-10">End Date</div>
                                                <input type="datetime-local" id="endDate">
                                            </fieldset>
                                        </div>

                                        <fieldset class="mt-20">
                                            <label><input type="checkbox" id="activeBanner" checked> Active</label>
                                        </fieldset>

                                        <div class="cols gap10 mt-20">
                                            <button type="button" class="tf-button w-full" onclick="closeFormSection()">Cancel</button>
                                            <button type="button" class="tf-button style-1 w-full" onclick="saveBanner()">Save Banner</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- banner-list -->
                                <div class="wg-box mb-20">
                                    <div class="wg-filter flex items-center justify-between gap10 flex-wrap">
                                        <div class="flex-grow">
                                            <div class="text-tiny mb-2">Manage your website banners</div>
                                        </div>
                                        <button onclick="showAddModal()" class="tf-button style-1 w208"><i
                                                class="icon-plus"></i>Add Banner</button>
                                    </div>

                                    <div class="divider"></div>

                                    <div class="wg-table table-banner-list">
                                        <ul class="table-title flex gap20 mb-14">
                                            <li><div class="body-title">Image</div></li>
                                            <li><div class="body-title">Title</div></li>
                                            <li><div class="body-title">Type</div></li>
                                            <li><div class="body-title">Page</div></li>
                                            <li><div class="body-title">Position</div></li>
                                            <li><div class="body-title">Dates</div></li>
                                            <li><div class="body-title">Status</div></li>
                                            <li><div class="body-title">Action</div></li>
                                        </ul>
                                        <ul id="bannersList" class="flex flex-column">
                                            <li class="product-item gap14"><div class="body-text">Loading banners...</div></li>
                                        </ul>
                                    </div>
                                    <div class="divider"></div>
                                    <div class="flex items-center justify-between flex-wrap gap10">
                                        <div id="banner-entries-info" class="text-tiny"></div>
                                        <ul id="banner-pagination" class="wg-pagination"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- bottom-page -->
                        <div class="bottom-page">
                            <div class="body-text">Copyright Â© 2024 Shubha Kuteer Design with</div>
                            <i class="icon-heart"></i>
                            <div class="body-text">by <a href="https://aptmedia.in">APT Media</a> All rights reserved.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Cloudinary config
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dknjr0tj2/upload";
        const UPLOAD_PRESET = "unsigned_products";

        let allBanners = [];
        let bannerCurrentPage = 1;
        const bannerPageSize = 10;

        // Load admin data
        async function loadAdminData() {
            try {
                const res = await fetch("/api/admin/users/me");
                if (!res.ok) throw new Error("Failed to fetch admin");
                const data = await res.json();
                document.getElementById("admin-name").textContent = data.admin.name;
                document.getElementById("admin-role").textContent = data.admin.role;
            } catch (err) {
                console.error("Error loading admin:", err);
            }
        }

        // Load banners on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAdminData();
            await loadBanners();
        });

        // Load all banners
        async function loadBanners() {
            try {
                console.log('Loading banners...');
                const res = await fetch('/api/admin/banners');
                if (!res.ok) throw new Error('Failed to load banners');

                const data = await res.json();
                allBanners = data.banners || [];

                renderBannersTable();
            } catch (error) {
                console.error('Error loading banners:', error);
                document.getElementById('bannersList').innerHTML = '<li class="product-item gap14"><div class="body-text">Failed to load banners</div></li>';
            }
        }

        // Render banners table with pagination
        function renderBannersTable() {
            const list = document.getElementById('bannersList');
            const entriesInfo = document.getElementById('banner-entries-info');
            const pagination = document.getElementById('banner-pagination');

            if (allBanners.length === 0) {
                list.innerHTML = '<li class="product-item gap14"><div class="body-text">No banners found</div></li>';
                entriesInfo.textContent = '';
                pagination.innerHTML = '';
                return;
            }

            const total = allBanners.length;
            const totalPages = Math.ceil(total / bannerPageSize);
            if (bannerCurrentPage > totalPages) bannerCurrentPage = totalPages;
            const start = (bannerCurrentPage - 1) * bannerPageSize;
            const end = Math.min(bannerCurrentPage * bannerPageSize, total);
            const pageBanners = allBanners.slice(start, end);

            list.innerHTML = pageBanners.map(banner => {
                const statusClass = banner.active ? 'success' : 'warning';
                const statusText = banner.active ? 'Active' : 'Inactive';

                return `
                    <li class="product-item gap14" style="align-items: center;">
                        <div style="flex: 0 0 100px;">
                            <img src="${banner.image_url}" alt="${banner.title}"
                                 style="max-width: 100px; max-height: 50px; object-fit: cover; border-radius: 4px;">
                        </div>
                        <div style="flex: 1;"><strong>${banner.title || 'N/A'}</strong></div>
                        <div style="flex: 1;">${banner.banner_type}</div>
                        <div style="flex: 1;">${banner.page_location || 'All'}</div>
                        <div style="flex: 1;">${banner.position}</div>
                        <div style="flex: 1;">
                            ${banner.start_date ? formatDate(banner.start_date) : 'N/A'}
                            ${banner.end_date ? ' to ' + formatDate(banner.end_date) : ''}
                        </div>
                        <div style="flex: 1;"><span class="block-available ${statusClass === 'success' ? '' : 'warning'}">${statusText}</span></div>
                        <div class="list-icon-function">
                            <div class="item edit" onclick="editBanner(${banner.id})"><i class="icon-edit-3"></i></div>
                            <div class="item eye" onclick="previewBanner(${banner.id})"><i class="icon-eye"></i></div>
                            <div class="item trash" onclick="deleteBanner(${banner.id})"><i class="icon-trash-2"></i></div>
                        </div>
                    </li>
                `;
            }).join('');

            // Entries info
            entriesInfo.textContent = `Showing ${start + 1}\u2013${end} of ${total} entries`;

            // Pagination
            pagination.innerHTML = '';
            if (totalPages <= 1) return;
            const prevLi = document.createElement('li');
            prevLi.innerHTML = '<a href="#"><i class="icon-chevron-left"></i></a>';
            if (bannerCurrentPage === 1) prevLi.classList.add('disabled');
            prevLi.addEventListener('click', e => { e.preventDefault(); if (bannerCurrentPage > 1) { bannerCurrentPage--; renderBannersTable(); } });
            pagination.appendChild(prevLi);
            for (let i = 1; i <= totalPages; i++) {
                const pLi = document.createElement('li');
                pLi.innerHTML = `<a href="#">${i}</a>`;
                if (i === bannerCurrentPage) pLi.classList.add('active');
                pLi.addEventListener('click', e => { e.preventDefault(); bannerCurrentPage = i; renderBannersTable(); });
                pagination.appendChild(pLi);
            }
            const nextLi = document.createElement('li');
            nextLi.innerHTML = '<a href="#"><i class="icon-chevron-right"></i></a>';
            if (bannerCurrentPage === totalPages) nextLi.classList.add('disabled');
            nextLi.addEventListener('click', e => { e.preventDefault(); if (bannerCurrentPage < totalPages) { bannerCurrentPage++; renderBannersTable(); } });
            pagination.appendChild(nextLi);
        }

        // --- Cloudinary Upload Helper ---
        async function uploadToCloudinary(file, progressBarId, statusId) {
            if (!file) return null;
            const progressBar = document.getElementById(progressBarId);
            const statusEl = document.getElementById(statusId);

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open("POST", CLOUDINARY_URL);

                xhr.upload.addEventListener("progress", (e) => {
                    if (e.lengthComputable && progressBar) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = pct + '%';
                        if (statusEl) statusEl.textContent = `Uploading... ${pct}%`;
                    }
                });

                xhr.addEventListener("load", () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const data = JSON.parse(xhr.responseText);
                        if (statusEl) statusEl.textContent = 'Upload complete!';
                        resolve(data.secure_url);
                    } else {
                        if (statusEl) statusEl.textContent = 'Upload failed!';
                        reject(new Error('Upload failed: ' + xhr.statusText));
                    }
                });

                xhr.addEventListener("error", () => {
                    if (statusEl) statusEl.textContent = 'Upload error!';
                    reject(new Error('Network error during upload'));
                });

                xhr.send(formData);
            });
        }

        // Extract Cloudinary public_id from URL
        function getCloudinaryPublicId(url) {
            if (!url || !url.includes('cloudinary')) return null;
            try {
                const parts = url.split('/upload/');
                if (parts.length < 2) return null;
                let path = parts[1];
                // Remove version prefix (e.g., v1234567890/)
                path = path.replace(/^v\d+\//, '');
                // Remove file extension
                path = path.replace(/\.[^/.]+$/, '');
                return path;
            } catch (e) {
                return null;
            }
        }

        // Delete image from Cloudinary
        async function deleteFromCloudinary(url) {
            const publicId = getCloudinaryPublicId(url);
            if (!publicId) return;
            try {
                await fetch('/api/admin/cloudinary/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ public_id: publicId })
                });
            } catch (e) {
                console.error('Failed to delete image from Cloudinary:', e);
            }
        }

        // --- Image Preview Helpers ---
        function showImagePreview(url, previewId, previewImgId, uploadAreaId) {
            document.getElementById(previewImgId).src = url;
            document.getElementById(previewId).style.display = 'block';
            document.getElementById(uploadAreaId).style.display = 'none';
        }

        function hideImagePreview(previewId, uploadAreaId, hiddenInputId, progressId) {
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(uploadAreaId).style.display = 'block';
            document.getElementById(hiddenInputId).value = '';
            if (progressId) {
                document.getElementById(progressId).style.display = 'none';
            }
        }

        // Remove main image
        async function removeMainImage() {
            const url = document.getElementById('imageUrl').value;
            if (url) await deleteFromCloudinary(url);
            hideImagePreview('imagePreview', 'imageUploadArea', 'imageUrl', 'mainImageProgress');
        }

        // Remove mobile image
        async function removeMobileImage() {
            const url = document.getElementById('mobileImageUrl').value;
            if (url) await deleteFromCloudinary(url);
            hideImagePreview('mobileImagePreview', 'mobileImageUploadArea', 'mobileImageUrl', 'mobileImageProgress');
        }

        // --- File Input Handlers ---
        document.getElementById('mainImageUpload').addEventListener('click', () => {
            document.getElementById('mainImageFile').click();
        });

        document.getElementById('mobileImageUpload').addEventListener('click', () => {
            document.getElementById('mobileImageFile').click();
        });

        document.getElementById('mainImageFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('mainImageProgress').style.display = 'block';
            document.getElementById('mainImageProgressBar').style.width = '0%';
            try {
                const url = await uploadToCloudinary(file, 'mainImageProgressBar', 'mainImageStatus');
                if (url) {
                    document.getElementById('imageUrl').value = url;
                    showImagePreview(url, 'imagePreview', 'imagePreviewImg', 'imageUploadArea');
                }
            } catch (err) {
                alert('Failed to upload banner image: ' + err.message);
            }
            e.target.value = '';
        });

        document.getElementById('mobileImageFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('mobileImageProgress').style.display = 'block';
            document.getElementById('mobileImageProgressBar').style.width = '0%';
            try {
                const url = await uploadToCloudinary(file, 'mobileImageProgressBar', 'mobileImageStatus');
                if (url) {
                    document.getElementById('mobileImageUrl').value = url;
                    showImagePreview(url, 'mobileImagePreview', 'mobileImagePreviewImg', 'mobileImageUploadArea');
                }
            } catch (err) {
                alert('Failed to upload mobile image: ' + err.message);
            }
            e.target.value = '';
        });

        // Show add modal
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Banner';
            document.getElementById('bannerForm').reset();
            document.getElementById('bannerId').value = '';
            document.getElementById('activeBanner').checked = true;
            // Reset image previews
            hideImagePreview('imagePreview', 'imageUploadArea', 'imageUrl', 'mainImageProgress');
            hideImagePreview('mobileImagePreview', 'mobileImageUploadArea', 'mobileImageUrl', 'mobileImageProgress');
            document.getElementById('bannerFormSection').style.display = 'block';
            document.getElementById('bannerFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Edit banner
        async function editBanner(id) {
            const banner = allBanners.find(b => b.id === id);
            if (!banner) return;

            document.getElementById('modalTitle').textContent = 'Edit Banner';
            document.getElementById('bannerId').value = banner.id;

            // Fill form
            document.getElementById('bannerTitle').value = banner.title || '';
            document.getElementById('bannerDescription').value = banner.description || '';
            document.getElementById('bannerType').value = banner.banner_type;
            document.getElementById('imageUrl').value = banner.image_url;
            document.getElementById('mobileImageUrl').value = banner.mobile_image_url || '';
            document.getElementById('linkUrl').value = banner.link_url || '';
            document.getElementById('linkTarget').value = banner.link_target || '_self';
            document.getElementById('position').value = banner.position;
            document.getElementById('pageLocation').value = banner.page_location || '';
            document.getElementById('startDate').value = formatDateTimeLocal(banner.start_date);
            document.getElementById('endDate').value = formatDateTimeLocal(banner.end_date);
            document.getElementById('activeBanner').checked = banner.active;

            // Show image previews if images exist
            if (banner.image_url) {
                showImagePreview(banner.image_url, 'imagePreview', 'imagePreviewImg', 'imageUploadArea');
            } else {
                hideImagePreview('imagePreview', 'imageUploadArea', 'imageUrl', 'mainImageProgress');
            }
            if (banner.mobile_image_url) {
                showImagePreview(banner.mobile_image_url, 'mobileImagePreview', 'mobileImagePreviewImg', 'mobileImageUploadArea');
            } else {
                hideImagePreview('mobileImagePreview', 'mobileImageUploadArea', 'mobileImageUrl', 'mobileImageProgress');
            }

            document.getElementById('bannerFormSection').style.display = 'block';
            document.getElementById('bannerFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Preview banner
        function previewBanner(id) {
            const banner = allBanners.find(b => b.id === id);
            if (banner && banner.image_url) {
                window.open(banner.image_url, '_blank');
            }
        }

        // Save banner
        async function saveBanner() {
            const id = document.getElementById('bannerId').value;
            const isEdit = !!id;

            const imageUrlVal = document.getElementById('imageUrl').value;
            console.log('imageUrl hidden input value:', imageUrlVal);

            const data = {
                title: document.getElementById('bannerTitle').value,
                description: document.getElementById('bannerDescription').value,
                banner_type: document.getElementById('bannerType').value,
                image_url: imageUrlVal,
                mobile_image_url: document.getElementById('mobileImageUrl').value || null,
                link_url: document.getElementById('linkUrl').value || null,
                link_target: document.getElementById('linkTarget').value,
                position: parseInt(document.getElementById('position').value) || 0,
                page_location: document.getElementById('pageLocation').value || null,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                active: document.getElementById('activeBanner').checked
            };

            if (!data.title) {
                alert('Please enter a banner title');
                return;
            }
            if (!data.image_url) {
                alert('Please upload a banner image first');
                return;
            }

            try {
                const url = isEdit ? `/api/admin/banners/${id}` : '/api/admin/banners';
                const method = isEdit ? 'PUT' : 'POST';

                console.log('Saving banner:', JSON.stringify(data, null, 2));

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const text = await res.text();
                console.log('Server response:', res.status, text);

                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error('Server returned invalid response: ' + text.substring(0, 200));
                }

                if (result.success) {
                    alert(isEdit ? 'Banner updated successfully' : 'Banner created successfully');
                    closeFormSection();
                    await loadBanners();
                } else {
                    alert('Failed to save: ' + (result.message || result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving banner:', error);
                alert('Failed to save banner: ' + error.message);
            }
        }

        // Delete banner (also removes images from Cloudinary)
        async function deleteBanner(id) {
            if (!confirm('Are you sure you want to delete this banner? This will also remove the uploaded images.')) return;

            try {
                // Find the banner to get image URLs before deleting
                const banner = allBanners.find(b => b.id === id);

                console.log('Deleting banner:', id);
                const res = await fetch(`/api/admin/banners/${id}`, {
                    method: 'DELETE'
                });

                const result = await res.json();

                if (result.success) {
                    // Clean up Cloudinary images
                    if (banner) {
                        if (banner.image_url) await deleteFromCloudinary(banner.image_url);
                        if (banner.mobile_image_url) await deleteFromCloudinary(banner.mobile_image_url);
                    }
                    alert('Banner deleted successfully');
                    await loadBanners();
                } else {
                    alert(result.message || 'Failed to delete banner');
                }
            } catch (error) {
                console.error('Error deleting banner:', error);
                alert('Failed to delete banner');
            }
        }

        // Close form section
        function closeFormSection() {
            document.getElementById('bannerFormSection').style.display = 'none';
        }
        function closeModal() {
            closeFormSection();
        }

        // Format date for datetime-local input
        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        }
    </script>

    <script src="/admin/js/jquery.min.js"></script>
    <script src="/admin/js/bootstrap.min.js"></script>
    <script src="/admin/js/bootstrap-select.min.js"></script>
    <script src="/admin/js/main.js"></script>
</body>
</html>
