<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Banners &amp; Cards - Shubha Kuteer Admin</title>
    <link rel="stylesheet" type="text/css" href="/admin/css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/animation.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/style.css">
    <link rel="stylesheet" href="/admin/font/fonts.css">
    <link rel="stylesheet" href="/admin/icon/style.css">
    <link rel="shortcut icon" href="/admin/images/favicon.png">
    <script>
        (async () => {
            try {
                const res = await fetch("/api/admin/auth/check", { credentials: "include" });
                if (!res.ok) window.location.href = "/admin/login.html";
            } catch {
                window.location.href = "/admin/login.html";
            }
        })();
    </script>
    <style>
        .page-tabs { display:flex; gap:0; border-bottom:2px solid #e8e8e8; margin-bottom:24px; }
        .page-tab { padding:10px 24px; cursor:pointer; font-size:14px; font-weight:600; color:#888; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all .2s; }
        .page-tab:hover { color:#2275fc; }
        .page-tab.active { color:#2275fc; border-bottom-color:#2275fc; }
        .slot-section { margin-bottom:28px; }
        .slot-section-title { font-size:15px; font-weight:600; margin-bottom:4px; color:#333; }
        .slot-section-desc { font-size:12px; color:#999; margin-bottom:14px; }
        .slot-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:18px; }
        .slot-card { border:1px solid #e8e8e8; border-radius:12px; overflow:hidden; background:#fff; transition:box-shadow .2s,transform .15s; }
        .slot-card:hover { box-shadow:0 4px 16px rgba(0,0,0,.08); transform:translateY(-1px); }
        .slot-card-img { width:100%; height:160px; overflow:hidden; background:#f5f5f5; position:relative; }
        .slot-card-img img { width:100%; height:100%; object-fit:cover; }
        .slot-card-badge { position:absolute; top:8px; right:8px; padding:2px 10px; border-radius:20px; font-size:10px; font-weight:700; text-transform:uppercase; }
        .badge-original { background:#e8f0fe; color:#2275fc; }
        .badge-custom { background:#fef3cd; color:#b45309; }
        .slot-card-body { padding:10px 14px; }
        .slot-card-label { font-weight:600; font-size:13px; color:#333; margin-bottom:2px; }
        .slot-card-sub { font-size:11px; color:#aaa; }
        .slot-card-actions { padding:8px 14px 12px; display:flex; gap:8px; border-top:1px solid #f0f0f0; }
        .slot-btn { flex:1; padding:6px 0; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; text-align:center; transition:all .15s; }
        .slot-btn-edit { background:#e8f0fe; color:#2275fc; }
        .slot-btn-edit:hover { background:#d0e0fc; }
        .slot-btn-revert { background:#fff0f0; color:#ff4d4f; }
        .slot-btn-revert:hover { background:#ffd6d6; }
        .slot-btn-revert:disabled { opacity:.4; cursor:not-allowed; }
        .edit-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); z-index:9999; align-items:center; justify-content:center; }
        .edit-overlay.open { display:flex; }
        .edit-modal { background:#fff; border-radius:16px; width:560px; max-width:95vw; max-height:90vh; overflow-y:auto; padding:28px; box-shadow:0 20px 60px rgba(0,0,0,.3); }
        .edit-modal h5 { margin-bottom:20px; }
        .edit-modal fieldset { margin-bottom:16px; }
        .edit-modal label { font-size:13px; font-weight:600; display:block; margin-bottom:6px; color:#333; }
        .edit-modal input[type="text"],.edit-modal textarea { width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px; outline:none; }
        .edit-modal input:focus,.edit-modal textarea:focus { border-color:#2275fc; }
        .edit-modal textarea { height:60px; resize:vertical; }
        .edit-modal .preview-img { width:100%; max-height:200px; object-fit:contain; border-radius:8px; border:1px solid #eee; margin-top:8px; }
        .upload-zone { border:2px dashed #ddd; border-radius:8px; padding:20px; text-align:center; cursor:pointer; color:#999; font-size:13px; }
        .upload-zone:hover { border-color:#2275fc; color:#2275fc; }
        .upload-progress { height:6px; background:#eee; border-radius:4px; margin-top:8px; overflow:hidden; display:none; }
        .upload-progress-bar { height:100%; background:#2275fc; width:0%; transition:width .3s; }
        .modal-btns { display:flex; gap:12px; margin-top:20px; }
        .modal-btns .slot-btn { padding:10px 0; font-size:14px; }
    </style>
</head>

<body class="body">
    <div id="wrapper">
        <div id="page" class="">
            <div class="layout-wrap">
                <div id="preload" class="preload-container">
                    <div class="preloading"><span></span></div>
                </div>

                <!-- section-menu-left -->
                <div class="section-menu-left">
                    <div class="box-logo w-120">
                        <a href="/admin/index.html" id="site-logo-inner">
                            <img class="" id="logo_header" alt="" src="/admin/images/logo/logo.png"
                                data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png">
                        </a>
                        <div class="button-show-hide"><i class="icon-menu-left"></i></div>
                    </div>
                    <div class="section-menu-left-wrap">
                        <div class="center">
                            <div class="center-item">
                                <div class="center-heading">Main Home</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-grid"></i></div>
                                            <div class="text">Dashboard</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item"><a href="/admin/index.html"><div class="text">Dashboard</div></a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">All page</div>
                                <ul class="menu-list">
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-shopping-cart"></i></div>
                                            <div class="text">Ecommerce</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item"><a href="/admin/add-product.html"><div class="text">Add Product</div></a></li>
                                            <li class="sub-menu-item"><a href="/admin/product-list.html"><div class="text">Product List</div></a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-layers"></i></div>
                                            <div class="text">Category</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item"><a href="/admin/category-list.html"><div class="text">Category list</div></a></li>
                                            <li class="sub-menu-item"><a href="/admin/new-category.html"><div class="text">New category</div></a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-box"></i></div>
                                            <div class="text">Attributes</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item"><a href="/admin/attributes.html"><div class="text">Attributes</div></a></li>
                                            <li class="sub-menu-item"><a href="/admin/add-attributes.html"><div class="text">Add attributes</div></a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-file-plus"></i></div>
                                            <div class="text">Order</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item"><a href="/admin/order-list.html"><div class="text">Order list</div></a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-tag"></i></div>
                                            <div class="text">Marketing</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item"><a href="/admin/banners.html" class="active"><div class="text">Banners</div></a></li>
                                            <li class="sub-menu-item"><a href="/admin/coupons.html"><div class="text">Coupons</div></a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item has-children">
                                        <a href="javascript:void(0);" class="menu-item-button">
                                            <div class="icon"><i class="icon-user"></i></div>
                                            <div class="text">User</div>
                                        </a>
                                        <ul class="sub-menu">
                                            <li class="sub-menu-item"><a href="/admin/all-user.html"><div class="text">All user</div></a></li>
                                            <li class="sub-menu-item"><a href="/admin/add-new-user.html"><div class="text">Add new user</div></a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="center-item">
                                <div class="center-heading">Setting</div>
                                <ul class="menu-list">
                                    <li class="menu-item"><a href="/admin/setting.html"><div class="icon"><i class="icon-settings"></i></div><div class="text">Setting</div></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="bot text-center">
                            <div class="wrap">
                                <div class="mb-20"><img src="/admin/images/menu-left/img-bot.png" alt=""></div>
                                <div class="mb-20">
                                    <h6>Hi, how can we help?</h6>
                                    <div class="text">Contact us if you have any assistance, we will contact you as soon as possible</div>
                                </div>
                                <a href="mailto:parthbuilds@gmail.com" class="tf-button w-full">Contact</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- section-content-right -->
                <div class="section-content-right">
                    <div class="header-dashboard">
                        <div class="wrap">
                            <div class="header-left">
                                <a href="/admin/index.html">
                                    <img class="" id="logo_header_mobile" alt="" src="/admin/images/logo/logo.png"
                                        data-light="images/logo/logo.png" data-dark="images/logo/logo-dark.png"
                                        data-width="154px" data-height="52px" data-retina="images/logo/logo@2x.png">
                                </a>
                                <div class="button-show-hide"><i class="icon-menu-left"></i></div>
                                <form class="form-search flex-grow">
                                    <fieldset class="name">
                                        <input type="text" placeholder="Search here..." class="show-search" name="name" tabindex="2" value="" aria-required="true" required="">
                                    </fieldset>
                                    <div class="button-submit"><button type="submit"><i class="icon-search"></i></button></div>
                                </form>
                            </div>
                            <div class="header-grid">
                                <div class="popup-wrap user type-header">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="header-user wg-user">
                                                <span class="image"><img src="/admin/images/avatar/user-1.png" alt=""></span>
                                                <span class="flex flex-column">
                                                    <span id="admin-name" class="body-title mb-2">Loading...</span>
                                                    <span id="admin-role" class="text-tiny">Admin</span>
                                                </span>
                                            </span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end has-content" aria-labelledby="dropdownMenuButton3">
                                            <li><a href="/admin/setting.html" class="user-item"><div class="icon"><i class="icon-settings"></i></div><div class="body-title-2">Setting</div></a></li>
                                            <li><a href="/admin/login.html" class="user-item"><div class="icon"><i class="icon-log-out"></i></div><div class="body-title-2">Log out</div></a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- main-content -->
                    <div class="main-content">
                        <div class="main-content-inner">
                            <div class="main-content-wrap">
                                <div class="flex items-center flex-wrap justify-between gap20 mb-27">
                                    <h3>Banners &amp; Cards</h3>
                                    <ul class="breadcrumbs flex items-center flex-wrap justify-start gap10">
                                        <li><a href="/admin/index.html"><div class="text-tiny">Dashboard</div></a></li>
                                        <li><i class="icon-chevron-right"></i></li>
                                        <li><div class="text-tiny">Banners &amp; Cards</div></li>
                                    </ul>
                                </div>

                                <div class="wg-box mb-20">
                                    <div class="flex items-center justify-between gap10 flex-wrap mb-14">
                                        <div>
                                            <h5>Page Banners &amp; Cards</h5>
                                            <div class="text-tiny mt-4">Select a page tab, then click Edit on any slot. Click Revert to restore the original image.</div>
                                        </div>
                                    </div>

                                    <div class="page-tabs" id="pageTabs">
                                        <div class="page-tab active" data-page="home">Home Page</div>
                                        <div class="page-tab" data-page="shop">Shop Page</div>
                                        <div class="page-tab" data-page="newcoll">New Collection</div>
                                    </div>

                                    <div id="slotContainer">Loading...</div>
                                </div>
                            </div>
                        </div>
                        <div class="bottom-page">
                            <div class="body-text">Copyright &copy; 2024 Shubha Kuteer Design with</div>
                            <i class="icon-heart"></i>
                            <div class="body-text">by <a href="https://aptmedia.in">APT Media</a> All rights reserved.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit modal overlay -->
    <div class="edit-overlay" id="editOverlay">
        <div class="edit-modal">
            <h5 id="editModalTitle">Edit Slot</h5>
            <input type="hidden" id="editSlotId">
            <fieldset>
                <label>Image</label>
                <div id="editImgPreviewWrap">
                    <img id="editImgPreview" class="preview-img" src="" style="display:none;">
                </div>
                <div class="upload-zone" id="editUploadZone" onclick="document.getElementById('editFileInput').click()">
                    Click to upload new image
                </div>
                <input type="file" id="editFileInput" accept="image/*" style="display:none;">
                <div class="upload-progress" id="editUploadProgress">
                    <div class="upload-progress-bar" id="editUploadBar"></div>
                </div>
                <input type="hidden" id="editImageUrl">
            </fieldset>
            <fieldset>
                <label>Title</label>
                <input type="text" id="editTitle" placeholder="Banner title text">
            </fieldset>
            <fieldset>
                <label>Subtitle / Description</label>
                <textarea id="editDescription" placeholder="e.g., Sale! Up To 30% Off!"></textarea>
            </fieldset>
            <fieldset>
                <label>Link URL</label>
                <input type="text" id="editLinkUrl" placeholder="e.g., shop.html?cat=Bedsheets">
            </fieldset>
            <div class="modal-btns">
                <button class="slot-btn slot-btn-revert" onclick="closeEditModal()">Cancel</button>
                <button class="slot-btn slot-btn-edit" onclick="saveSlot()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dknjr0tj2/upload";
        const UPLOAD_PRESET = "unsigned_products";

        // ===== ALL 11 SLOT DEFAULTS =====
        const SLOT_DEFAULTS = {
            // HOME PAGE - 3 Hero Sliders
            home_hero_1: {
                page: 'home', section: 'Hero Slider', label: 'Hero Slide 1',
                banner_type: 'hero', page_location: 'home',
                title: 'Soft Absorbent Towels for Lasting Freshness',
                description: 'Sale! Up To 30% Off!',
                image_url: '/assets/images/banner/home-banner-2.png',
                link_url: 'shop.html?cat=Honeycomb%20Towels'
            },
            home_hero_2: {
                page: 'home', section: 'Hero Slider', label: 'Hero Slide 2',
                banner_type: 'hero', page_location: 'home',
                title: 'Stylish Pillow Covers for Cozy Living',
                description: 'Sale! Up To 50% Off!',
                image_url: '/assets/images/banner/home-banner-3.png',
                link_url: 'shop.html?cat=Cushions%20and%20Pillow%20Covers'
            },
            home_hero_3: {
                page: 'home', section: 'Hero Slider', label: 'Hero Slide 3',
                banner_type: 'hero', page_location: 'home',
                title: 'Premium Bedsheets Crafted for Comfort',
                description: 'Sale! Up To 50% Off!',
                image_url: '/assets/images/banner/home-banner-4.png',
                link_url: 'shop.html?cat=Bedsheets'
            },
            // HOME PAGE - 3 Offer Cards
            home_card_1: {
                page: 'home', section: 'Offer Cards', label: 'Offer Card 1',
                banner_type: 'promotional', page_location: 'home',
                title: 'New Arrivals sale 20% off',
                description: '',
                image_url: '/assets/images/card/offer-banner-1.png',
                link_url: 'shop.html?cat=Bags%20and%20Kits'
            },
            home_card_2: {
                page: 'home', section: 'Offer Cards', label: 'Offer Card 2',
                banner_type: 'promotional', page_location: 'home',
                title: 'Winter Sale collection',
                description: '',
                image_url: '/assets/images/card/offer-banner-2.png',
                link_url: 'shop.html?cat=Dohar%20and%20Quilts'
            },
            home_card_3: {
                page: 'home', section: 'Offer Cards', label: 'Offer Card 3',
                banner_type: 'promotional', page_location: 'home',
                title: '20% off accessories',
                description: '',
                image_url: '/assets/images/card/offer-banner-3.png',
                link_url: 'shop.html?cat=Honeycomb%20Towels'
            },
            // SHOP PAGE - 1 Banner
            shop_banner: {
                page: 'shop', section: 'Shop Banner', label: 'Shop Page Banner',
                banner_type: 'hero', page_location: 'shop',
                title: 'Make Your House a Home With Style',
                description: 'Sale! Up To 50% Off!',
                image_url: '/assets/images/banner/Shubha Kuteer website.png',
                link_url: 'shop.html?cat=Bedsheets'
            },
            // NEW COLLECTION PAGE - 1 Banner + 3 Cards
            newcoll_banner: {
                page: 'newcoll', section: 'Collection Banner', label: 'Collection Page Banner',
                banner_type: 'hero', page_location: 'newcoll',
                title: 'Transform Your Look This Winter',
                description: 'Sale! Up To 50% Off!',
                image_url: '/assets/images/banner/new-collection banner.png',
                link_url: 'shop.html?cat=Bags%20and%20Kits'
            },
            newcoll_card_1: {
                page: 'newcoll', section: 'Feature Cards', label: 'Feature Card 1',
                banner_type: 'promotional', page_location: 'newcoll',
                title: 'New Arrivals sale 20% off',
                description: '',
                image_url: '/assets/images/card/offer-banner-4.png',
                link_url: 'shop.html?cat=Honeycomb%20Towels'
            },
            newcoll_card_2: {
                page: 'newcoll', section: 'Feature Cards', label: 'Feature Card 2',
                banner_type: 'promotional', page_location: 'newcoll',
                title: 'Hand Bags collection',
                description: '',
                image_url: '/assets/images/card/offer-banner-5.png',
                link_url: 'shop.html?cat=Bags%20and%20Kits'
            },
            newcoll_card_3: {
                page: 'newcoll', section: 'Feature Cards', label: 'Feature Card 3',
                banner_type: 'promotional', page_location: 'newcoll',
                title: '20% off accessories',
                description: '',
                image_url: '/assets/images/card/offer-banner-6.png',
                link_url: 'shop.html?cat=Bags%20and%20Kits'
            }
        };

        // Page section descriptions
        const PAGE_INFO = {
            home: {
                sections: {
                    'Hero Slider': { desc: 'Full-width slider at the very top of the homepage (3 rotating slides)' },
                    'Offer Cards': { desc: '3 promotional cards shown below the collections grid' }
                }
            },
            shop: {
                sections: {
                    'Shop Banner': { desc: 'Full-width background banner at the top of the shop page' }
                }
            },
            newcoll: {
                sections: {
                    'Collection Banner': { desc: 'Full-width background banner at the top of the new collection page' },
                    'Feature Cards': { desc: '3 feature cards shown at the bottom of the page' }
                }
            }
        };

        let customSlots = {}; // Data from DB
        let activePage = 'home';

        // Load admin name
        async function loadAdminData() {
            try {
                const res = await fetch("/api/admin/users/me");
                if (!res.ok) return;
                const data = await res.json();
                document.getElementById("admin-name").textContent = data.admin.name;
                document.getElementById("admin-role").textContent = data.admin.role;
            } catch(e) {}
        }

        // Load slot data from API
        async function loadSlots() {
            try {
                const res = await fetch('/api/admin/banners');
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                customSlots = data.slots || {};
            } catch(e) {
                console.error('Failed to load slots:', e);
                customSlots = {};
            }
            renderPage();
        }

        // Get current data for a slot (custom if exists, else default)
        function getSlotData(slotId) {
            const def = SLOT_DEFAULTS[slotId];
            if (!def) return null;
            const custom = customSlots[slotId];
            if (custom) {
                return {
                    ...def,
                    title: custom.title || def.title,
                    description: custom.description || def.description,
                    image_url: custom.image_url || def.image_url,
                    link_url: custom.link_url || def.link_url,
                    isCustom: true
                };
            }
            return { ...def, isCustom: false };
        }

        // Render the active page tab
        function renderPage() {
            const container = document.getElementById('slotContainer');
            const slots = Object.entries(SLOT_DEFAULTS).filter(([_, v]) => v.page === activePage);

            // Group by section
            const sections = {};
            slots.forEach(([id, def]) => {
                if (!sections[def.section]) sections[def.section] = [];
                sections[def.section].push(id);
            });

            let html = '';
            for (const [sectionName, slotIds] of Object.entries(sections)) {
                const info = PAGE_INFO[activePage]?.sections?.[sectionName] || {};
                html += `<div class="slot-section">`;
                html += `<div class="slot-section-title">${sectionName}</div>`;
                if (info.desc) html += `<div class="slot-section-desc">${info.desc}</div>`;
                html += `<div class="slot-grid">`;

                slotIds.forEach(slotId => {
                    const data = getSlotData(slotId);
                    const badgeClass = data.isCustom ? 'badge-custom' : 'badge-original';
                    const badgeText = data.isCustom ? 'Custom' : 'Original';

                    html += `
                        <div class="slot-card">
                            <div class="slot-card-img">
                                <img src="${data.image_url}" alt="${data.label}" onerror="this.src='/admin/images/products/default-order.png'">
                                <span class="slot-card-badge ${badgeClass}">${badgeText}</span>
                            </div>
                            <div class="slot-card-body">
                                <div class="slot-card-label">${data.label}</div>
                                <div class="slot-card-sub">${data.title}</div>
                            </div>
                            <div class="slot-card-actions">
                                <button class="slot-btn slot-btn-edit" onclick="editSlot('${slotId}')">Edit</button>
                                <button class="slot-btn slot-btn-revert" onclick="revertSlot('${slotId}')" ${data.isCustom ? '' : 'disabled'}>Revert</button>
                            </div>
                        </div>`;
                });

                html += `</div></div>`;
            }

            container.innerHTML = html || '<div style="text-align:center; padding:40px; color:#aaa;">No slots for this page.</div>';
        }

        // Page tab click
        function initTabs() {
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    activePage = tab.dataset.page;
                    renderPage();
                });
            });
        }

        // Open edit modal
        function editSlot(slotId) {
            const data = getSlotData(slotId);
            if (!data) return;

            document.getElementById('editSlotId').value = slotId;
            document.getElementById('editModalTitle').textContent = 'Edit: ' + data.label;
            document.getElementById('editTitle').value = data.title || '';
            document.getElementById('editDescription').value = data.description || '';
            document.getElementById('editLinkUrl').value = data.link_url || '';
            document.getElementById('editImageUrl').value = data.image_url || '';

            const preview = document.getElementById('editImgPreview');
            if (data.image_url) {
                preview.src = data.image_url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            document.getElementById('editOverlay').classList.add('open');
        }

        function closeEditModal() {
            document.getElementById('editOverlay').classList.remove('open');
        }

        // Save slot
        async function saveSlot() {
            const slotId = document.getElementById('editSlotId').value;
            const def = SLOT_DEFAULTS[slotId];
            if (!def) return;

            const body = {
                title: document.getElementById('editTitle').value,
                description: document.getElementById('editDescription').value,
                image_url: document.getElementById('editImageUrl').value,
                link_url: document.getElementById('editLinkUrl').value,
                banner_type: def.banner_type,
                page_location: def.page_location
            };

            if (!body.image_url) { alert('Please upload an image'); return; }

            try {
                const res = await fetch(`/api/admin/banners/slot/${slotId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    closeEditModal();
                    await loadSlots();
                } else {
                    alert(data.message || 'Failed to save');
                }
            } catch(e) {
                alert('Error saving slot');
            }
        }

        // Revert slot to original
        async function revertSlot(slotId) {
            const def = SLOT_DEFAULTS[slotId];
            if (!confirm(`Revert "${def.label}" to the original image and text?`)) return;

            try {
                const res = await fetch(`/api/admin/banners/slot/${slotId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    await loadSlots();
                } else {
                    alert(data.message || 'Failed to revert');
                }
            } catch(e) {
                alert('Error reverting slot');
            }
        }

        // Cloudinary upload
        document.getElementById('editFileInput').addEventListener('change', async function() {
            const file = this.files[0];
            if (!file) return;

            const progressWrap = document.getElementById('editUploadProgress');
            const progressBar = document.getElementById('editUploadBar');
            const preview = document.getElementById('editImgPreview');
            const uploadZone = document.getElementById('editUploadZone');

            progressWrap.style.display = 'block';
            progressBar.style.width = '0%';
            uploadZone.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', CLOUDINARY_URL);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        progressBar.style.width = Math.round((e.loaded / e.total) * 100) + '%';
                    }
                };

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        document.getElementById('editImageUrl').value = data.secure_url;
                        preview.src = data.secure_url;
                        preview.style.display = 'block';
                        uploadZone.textContent = 'Click to upload a different image';
                    } else {
                        alert('Upload failed');
                        uploadZone.textContent = 'Click to upload new image';
                    }
                    progressWrap.style.display = 'none';
                };

                xhr.onerror = function() {
                    alert('Upload error');
                    progressWrap.style.display = 'none';
                    uploadZone.textContent = 'Click to upload new image';
                };

                xhr.send(formData);
            } catch(e) {
                alert('Upload failed');
                progressWrap.style.display = 'none';
                uploadZone.textContent = 'Click to upload new image';
            }

            this.value = '';
        });

        // Close modal on overlay click
        document.getElementById('editOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAdminData();
            initTabs();
            await loadSlots();
        });
    </script>

    <script src="/admin/js/jquery.min.js"></script>
    <script src="/admin/js/bootstrap.min.js"></script>
    <script src="/admin/js/bootstrap-select.min.js"></script>
    <script src="/admin/js/main.js"></script>
</body>
</html>
